<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Marketing AI Assistant</title>
    <style>
      :root {
        --bg: #0b101b;
        --panel: #10192c;
        --panel-2: #13203a;
        --line: #2a3b59;
        --line-soft: #1f2b43;
        --text: #e8eefb;
        --muted: #9caed0;
        --accent: #8dc1ff;
        --assistant: #13213d;
        --user: #20406f;
        --good: #8fe3b2;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        color: var(--text);
        font: 14px/1.5 "Segoe UI", "Inter", "Helvetica Neue", sans-serif;
        background:
          radial-gradient(1200px 700px at 88% -10%, #203c6d 0, transparent 60%),
          radial-gradient(900px 500px at -10% 100%, #17284a 0, transparent 60%),
          var(--bg);
      }
      .app {
        display: grid;
        grid-template-columns: 300px 1fr;
        min-height: 100vh;
      }
      .sidebar-backdrop {
        display: none;
      }
      .mobile-nav {
        display: none;
      }
      .sidebar {
        border-right: 1px solid var(--line-soft);
        padding: 14px;
        background: linear-gradient(180deg, #0e1628, #0c1323);
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .menu-btn {
        display: none;
      }
      .main {
        display: flex;
        flex-direction: column;
        min-width: 0;
      }
      .topbar {
        border-bottom: 1px solid var(--line-soft);
        padding: 12px 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #0f182b;
        gap: 10px;
      }
      .brand {
        display: flex;
        flex-direction: column;
      }
      .topbar-left {
        display: flex;
        align-items: center;
        gap: 10px;
        min-width: 0;
      }
      .title {
        font-weight: 700;
        font-size: 16px;
      }
      .subtle {
        font-size: 12px;
        color: var(--muted);
      }
      .row {
        display: flex;
        gap: 8px;
      }
      .col {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      button,
      input,
      select,
      textarea {
        border: 1px solid var(--line);
        border-radius: 10px;
        background: var(--panel-2);
        color: var(--text);
        padding: 10px 11px;
        font-size: 13px;
      }
      button {
        cursor: pointer;
      }
      button:hover {
        border-color: #4b6694;
      }
      button:disabled {
        opacity: 0.65;
        cursor: not-allowed;
      }
      .ghost {
        background: transparent;
        border-color: var(--line-soft);
      }
      .good {
        color: var(--good);
      }
      .search {
        width: 100%;
      }
      .list {
        overflow: auto;
        display: flex;
        flex-direction: column;
        gap: 8px;
        flex: 1;
      }
      .item {
        border: 1px solid var(--line-soft);
        border-radius: 10px;
        background: #111b31;
        text-align: left;
        padding: 10px;
      }
      .item.active {
        border-color: #3f6298;
        background: #182743;
      }
      .item .t {
        font-weight: 600;
        font-size: 13px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .item .d {
        font-size: 11px;
        color: var(--muted);
        margin-top: 4px;
      }
      .folder-list {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }
      .folder-chip {
        border: 1px solid #385989;
        border-radius: 999px;
        padding: 4px 9px;
        font-size: 11px;
        background: #12203a;
        cursor: pointer;
      }
      .folder-chip.active {
        border-color: #6f9de0;
        background: #19315a;
      }
      .conv-row {
        border: 1px solid var(--line-soft);
        border-radius: 10px;
        background: #111b31;
        padding: 8px;
        display: flex;
        flex-direction: column;
        gap: 6px;
        position: relative;
      }
      .conv-row.active {
        border-color: #3f6298;
        background: #182743;
      }
      .conv-head {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 8px;
      }
      .conv-open {
        border: 0;
        padding: 0;
        background: transparent;
        text-align: left;
        color: var(--text);
        flex: 1;
      }
      .conv-actions {
        display: flex;
        gap: 6px;
      }
      .mini {
        font-size: 11px;
        padding: 4px 7px;
        border-radius: 8px;
      }
      .kebab {
        border: 1px solid #2f4469;
        border-radius: 8px;
        background: transparent;
        color: #cfe0ff;
        padding: 3px 8px;
        line-height: 1;
        font-size: 17px;
        min-width: 34px;
      }
      .conv-menu {
        position: absolute;
        top: 38px;
        right: 10px;
        z-index: 30;
        min-width: 170px;
        border: 1px solid #2a3b59;
        border-radius: 12px;
        background: #101a2f;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.4);
        padding: 6px;
        display: none;
      }
      .conv-menu.show {
        display: block;
      }
      .conv-menu button {
        width: 100%;
        text-align: left;
        border: 0;
        border-radius: 8px;
        background: transparent;
        color: var(--text);
        padding: 8px 10px;
      }
      .conv-menu button:hover {
        background: #1a2a49;
      }
      .conv-menu button.danger {
        color: #ff8c8c;
      }
      .kpis {
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 10px;
        padding: 10px 14px;
        border-bottom: 1px solid var(--line-soft);
        background: #0f1729;
      }
      .legacy-kpis {
        display: none;
      }
      .kpi-tabs-wrap {
        border-bottom: 1px solid var(--line-soft);
        background: #0f1729;
        padding: 10px 14px;
      }
      .kpi-toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
        gap: 8px;
      }
      .kpi-toolbar .left,
      .kpi-toolbar .right {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .muted-pill {
        border: 1px solid #2f456c;
        border-radius: 999px;
        padding: 4px 10px;
        font-size: 11px;
        color: #a9bce0;
        background: #0f1a2f;
      }
      .kpi-tabs {
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 8px;
      }
      .kpi-tab {
        border: 1px solid #2f456c;
        border-radius: 999px;
        background: #0f1a2f;
        color: #d8e5ff;
        padding: 8px 10px;
        font-size: 12px;
        text-align: center;
      }
      .kpi-tab.active {
        border-color: #6f9de0;
        background: #1a315a;
      }
      .tab-hint {
        margin-top: 8px;
        font-size: 11px;
        color: #9eb2d8;
      }
      .kpi-panel {
        margin-top: 10px;
        display: none;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 10px;
      }
      .kpi-panel.active {
        display: grid;
      }
      .statusbar {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 14px;
        border-bottom: 1px solid var(--line-soft);
        background: #101a2f;
      }
      .status-dot {
        width: 9px;
        height: 9px;
        border-radius: 50%;
        background: #6d7f9f;
      }
      .status-text {
        font-size: 12px;
        color: var(--muted);
      }
      .status-spacer {
        flex: 1;
      }
      .ga4-badge {
        font-size: 11px;
        border-radius: 999px;
        padding: 4px 10px;
        border: 1px solid #314a73;
        background: #12203a;
        color: #b8cbec;
      }
      .ga4-badge.ok {
        border-color: #2f7f57;
        background: #123027;
        color: #99e5bf;
      }
      .ga4-badge.warn {
        border-color: #7b6a2f;
        background: #312910;
        color: #f4dc98;
      }
      .ga4-badge.err {
        border-color: #7f3939;
        background: #331414;
        color: #f3b0b0;
      }
      .kpi {
        border: 1px solid var(--line-soft);
        border-radius: 12px;
        background: #111d34;
        padding: 10px;
      }
      .kpi .name {
        font-size: 11px;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.02em;
      }
      .kpi .value {
        margin-top: 4px;
        font-size: 17px;
        font-weight: 700;
      }
      .kpi .subvalue {
        margin-top: 3px;
        font-size: 11px;
        color: var(--muted);
        white-space: normal;
        overflow-wrap: anywhere;
        line-height: 1.3;
      }
      .kpi.meta-card {
        border-color: #2f4f81;
        background: linear-gradient(180deg, #12213b, #101b31);
      }
      .kpi.ig-card {
        border-color: #6d4a6e;
        background: linear-gradient(180deg, #231936, #1a1430);
      }
      .kpi-extra {
        margin-top: 6px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }
      .kpi-delta {
        font-size: 11px;
        border-radius: 999px;
        padding: 2px 7px;
        border: 1px solid #314a73;
        color: #b9ccec;
      }
      .kpi-delta.up {
        border-color: #2f7f57;
        color: #9be4bf;
      }
      .kpi-delta.down {
        border-color: #8a3f3f;
        color: #f5b2b2;
      }
      .kpi-spark {
        display: flex;
        align-items: flex-end;
        gap: 2px;
        height: 14px;
      }
      .kpi-spark i {
        width: 3px;
        border-radius: 2px;
        background: #5f8bc7;
        opacity: 0.8;
        display: inline-block;
      }
      .alert-strip {
        display: none;
        align-items: center;
        gap: 8px;
        padding: 8px 14px;
        border-bottom: 1px solid var(--line-soft);
        background: #2b2414;
        color: #f2d39a;
        font-size: 12px;
      }
      .alert-strip.show {
        display: flex;
      }
      .alert-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #ffbf5c;
      }
      .inline-actions {
        display: flex;
        gap: 8px;
        margin-top: 10px;
      }
      .compact .kpi-panel {
        gap: 8px;
      }
      .compact .kpi {
        padding: 8px;
      }
      .compact .kpi .value {
        font-size: 15px;
      }
      .chat-wrap {
        flex: 1;
        min-height: 0;
        display: flex;
        flex-direction: column;
        padding: 12px;
        gap: 10px;
        position: relative;
      }
      .chat {
        flex: 1;
        overflow: auto;
        border: 1px solid var(--line-soft);
        border-radius: 14px;
        background: linear-gradient(180deg, #0f182c, #0c1425);
        padding: 14px;
      }
      .empty {
        border: 1px dashed #30476f;
        border-radius: 14px;
        padding: 16px;
        background: #111b30;
      }
      .chips {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 10px;
      }
      .chip {
        border: 1px solid #385989;
        border-radius: 999px;
        padding: 6px 10px;
        font-size: 12px;
        background: #12203a;
        cursor: pointer;
      }
      .msg {
        display: flex;
        gap: 10px;
        margin: 14px 0;
        animation: rise 0.18s ease-out;
      }
      @keyframes rise {
        from {
          transform: translateY(6px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }
      .msg.user {
        justify-content: flex-end;
      }
      .msg.user .avatar {
        order: 2;
      }
      .msg.user .content {
        order: 1;
        align-items: flex-end;
      }
      .avatar {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        display: grid;
        place-items: center;
        font-size: 11px;
        font-weight: 700;
        background: #1f3458;
        border: 1px solid #35527f;
        flex: 0 0 28px;
      }
      .msg.user .avatar {
        background: #2f5b96;
        border-color: #507dc0;
      }
      .content {
        max-width: min(78%, 860px);
        min-width: 0;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      .meta {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 11px;
        color: var(--muted);
        text-transform: uppercase;
      }
      .ts {
        color: #7f93b8;
      }
      .bubble {
        border: 1px solid #2b3f63;
        border-radius: 12px;
        background: var(--assistant);
        padding: 11px 12px;
        overflow: auto;
      }
      .msg.user .bubble {
        background: var(--user);
        border-color: #3f68a6;
      }
      .bubble p {
        margin: 0 0 8px;
      }
      .bubble p:last-child {
        margin-bottom: 0;
      }
      .bubble ul,
      .bubble ol {
        margin: 7px 0 7px 20px;
        padding: 0;
      }
      .bubble table {
        border-collapse: collapse;
        width: 100%;
        margin: 8px 0;
      }
      .bubble th,
      .bubble td {
        border: 1px solid #314a73;
        padding: 6px 8px;
        text-align: left;
      }
      .bubble th {
        background: #162641;
      }
      .bubble pre {
        margin: 8px 0;
        padding: 10px;
        border-radius: 9px;
        border: 1px solid #30476f;
        background: #0e1729;
        overflow: auto;
      }
      .bubble code {
        border: 1px solid #334c76;
        background: #0f1a2e;
        border-radius: 6px;
        padding: 1px 5px;
        font-family: Consolas, "Courier New", monospace;
      }
      .bubble pre code {
        border: 0;
        background: transparent;
        padding: 0;
      }
      .actions {
        display: flex;
        justify-content: flex-end;
        gap: 6px;
      }
      .icon {
        font-size: 11px;
        padding: 4px 8px;
        border: 1px solid #2f4469;
        border-radius: 8px;
        background: transparent;
      }
      .edit-box {
        display: flex;
        flex-direction: column;
        gap: 8px;
        width: clamp(280px, 56vw, 760px);
        max-width: 100%;
      }
      .edit-input {
        width: 100%;
        min-height: 140px;
        resize: vertical;
        border: 1px solid var(--line);
        border-radius: 10px;
        background: #0f1b33;
        color: var(--text);
        padding: 10px;
        font: inherit;
      }
      .composer {
        border: 1px solid var(--line-soft);
        border-radius: 14px;
        padding: 10px;
        background: #101a2f;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .composer input {
        width: 100%;
        font-size: 15px;
      }
      .typing {
        display: inline-flex;
        gap: 4px;
      }
      .scroll-top-btn {
        position: absolute;
        right: 22px;
        bottom: 110px;
        width: 44px;
        height: 44px;
        border-radius: 999px;
        border: 1px solid #365689;
        background: #142546;
        color: #e8eefb;
        font-size: 20px;
        font-weight: 700;
        display: grid;
        place-items: center;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.18s ease;
      }
      .scroll-top-btn.show {
        opacity: 1;
        pointer-events: auto;
      }
      .dot {
        width: 7px;
        height: 7px;
        border-radius: 50%;
        background: var(--accent);
        opacity: 0.35;
        animation: pulse 1.2s infinite ease-in-out;
      }
      .dot:nth-child(2) {
        animation-delay: 0.2s;
      }
      .dot:nth-child(3) {
        animation-delay: 0.4s;
      }
      @keyframes pulse {
        0%,
        80%,
        100% {
          transform: scale(0.75);
          opacity: 0.35;
        }
        40% {
          transform: scale(1);
          opacity: 1;
        }
      }
      @media (max-width: 1060px) {
        .kpis {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
      }
      @media (max-width: 900px) {
        .app {
          grid-template-columns: 1fr;
          min-height: 100dvh;
        }
        body.sidebar-open {
          overflow: hidden;
        }
        .sidebar-backdrop {
          display: block;
          position: fixed;
          inset: 0;
          background: rgba(3, 8, 16, 0.62);
          backdrop-filter: blur(2px);
          opacity: 0;
          pointer-events: none;
          transition: opacity 0.18s ease;
          z-index: 39;
          border: 0;
          padding: 0;
          margin: 0;
        }
        body.sidebar-open .sidebar-backdrop {
          opacity: 1;
          pointer-events: auto;
        }
        .sidebar {
          position: fixed;
          left: 0;
          top: 0;
          bottom: 0;
          width: min(86vw, 360px);
          padding: 12px;
          gap: 8px;
          max-height: 100dvh;
          overflow: auto;
          border-right: 1px solid var(--line-soft);
          border-bottom: 0;
          z-index: 40;
          box-shadow: 18px 0 40px rgba(0, 0, 0, 0.45);
          transform: translateX(-105%);
          transition: transform 0.2s ease;
        }
        body.sidebar-open .sidebar {
          transform: translateX(0);
        }
        .sidebar .row {
          flex-wrap: wrap;
        }
        .sidebar .row > * {
          flex: 1 1 calc(50% - 4px);
          min-width: 120px;
        }
        .topbar {
          position: sticky;
          top: 0;
          z-index: 20;
          background: rgba(15, 24, 43, 0.93);
          backdrop-filter: blur(8px);
          flex-direction: row;
          flex-wrap: wrap;
          align-items: center;
          justify-content: space-between;
          padding: 10px 12px;
        }
        .topbar-left {
          width: 100%;
        }
        .menu-btn {
          display: inline-flex;
          align-items: center;
          justify-content: center;
          width: 40px;
          height: 40px;
          border-radius: 12px;
          font-size: 18px;
          padding: 0;
          flex: 0 0 40px;
        }
        .brand {
          min-width: 0;
        }
        .brand .subtle {
          font-size: 11px;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }
        .topbar .row {
          width: 100%;
          display: grid;
          grid-template-columns: repeat(3, minmax(0, 1fr));
          gap: 6px;
        }
        .topbar .row > * {
          width: 100%;
          min-width: 0;
          text-align: center;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }
        .kpi-tabs-wrap {
          padding: 10px 12px;
        }
        .kpi-toolbar {
          flex-direction: row;
          justify-content: space-between;
          align-items: center;
          flex-wrap: wrap;
        }
        .kpi-tabs {
          display: grid;
          grid-auto-flow: column;
          grid-auto-columns: minmax(170px, 1fr);
          overflow-x: auto;
          gap: 8px;
          padding-bottom: 4px;
          scroll-snap-type: x mandatory;
        }
        .kpi-tab {
          scroll-snap-align: start;
          white-space: nowrap;
        }
        .kpi-panel,
        .kpi-panel.active {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
        .statusbar {
          flex-wrap: wrap;
          row-gap: 6px;
        }
        .status-spacer {
          display: none;
        }
        .chat-wrap {
          padding: 8px;
          gap: 8px;
          padding-bottom: 76px;
        }
        .chat {
          padding: 10px;
          border-radius: 12px;
        }
        .content {
          max-width: 100%;
        }
        .msg .content {
          max-width: calc(100% - 38px);
        }
        .composer {
          position: sticky;
          bottom: 0;
          border-radius: 12px;
          background: rgba(16, 26, 47, 0.95);
          backdrop-filter: blur(6px);
        }
        .composer .row {
          flex-wrap: nowrap;
        }
        .composer .row input {
          min-width: 0;
          flex: 1 1 auto;
        }
        .composer .row button {
          flex: 0 0 auto;
          white-space: nowrap;
        }
        .chips {
          flex-wrap: nowrap;
          overflow-x: auto;
          padding-bottom: 2px;
          margin-top: 6px;
        }
        .chip {
          flex: 0 0 auto;
          white-space: nowrap;
        }
        .scroll-top-btn {
          right: 14px;
          bottom: 148px;
        }
        .mobile-nav {
          position: fixed;
          left: 10px;
          right: 10px;
          bottom: 10px;
          z-index: 45;
          display: grid;
          grid-template-columns: repeat(3, minmax(0, 1fr));
          gap: 8px;
          padding: 8px;
          border: 1px solid #2b4167;
          border-radius: 14px;
          background: rgba(10, 20, 37, 0.9);
          backdrop-filter: blur(8px);
          box-shadow: 0 14px 34px rgba(0, 0, 0, 0.4);
        }
        .mobile-nav button {
          border-radius: 10px;
          padding: 10px 8px;
          font-size: 12px;
          text-align: center;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
          background: #0f1a30;
          border-color: #29436d;
        }
        .mobile-nav button.active {
          background: linear-gradient(180deg, #20406f, #1a3053);
          border-color: #6f9de0;
        }
      }
      @media (max-width: 560px) {
        .kpis {
          grid-template-columns: 1fr;
        }
        .sidebar {
          width: min(92vw, 360px);
        }
        .sidebar .row > * {
          flex: 1 1 100%;
        }
        .topbar {
          padding: 10px;
        }
        .topbar .row {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
        .topbar .row > * {
          font-size: 12px;
          padding: 9px 8px;
        }
        .muted-pill {
          text-align: center;
        }
        .kpi-panel,
        .kpi-panel.active {
          grid-template-columns: 1fr;
        }
        .composer .row {
          flex-direction: column;
        }
        .composer .row button {
          width: 100%;
        }
        .msg {
          gap: 8px;
        }
        .avatar {
          width: 24px;
          height: 24px;
          flex: 0 0 24px;
          font-size: 10px;
        }
        .bubble {
          padding: 9px 10px;
        }
        .chat {
          padding: 8px;
        }
        .mobile-nav {
          left: 8px;
          right: 8px;
          bottom: 8px;
        }
        .edit-box {
          width: 100%;
        }
        .edit-input {
          min-height: 120px;
        }
      }
    </style>
  </head>
  <body>
    <div class="app">
      <aside class="sidebar">
        <div class="row">
          <button id="newChat">+ New Chat</button>
          <button id="clearChat" class="ghost">Clear</button>
        </div>
        <div class="row">
          <button id="newFolder" class="ghost">+ Folder</button>
          <button id="renameFolder" class="ghost">Rename</button>
          <button id="deleteFolder" class="ghost">Delete</button>
        </div>
        <div id="folderList" class="folder-list"></div>
        <input id="searchConv" class="search" placeholder="Search conversations..." />
        <div class="subtle">Conversation History</div>
        <div id="convList" class="list"></div>

        <div class="col">
          <div class="subtle">Backend URL</div>
          <input id="backendUrl" placeholder="http://localhost:8080" />
          <div class="subtle">x-api-key</div>
          <input id="apiKey" placeholder="Enter your x-api-key" />
          <div class="subtle">Meta Account</div>
          <select id="metaAccount">
            <option value="">Default account</option>
          </select>
          <div class="row">
            <button id="saveCfg">Save</button>
            <button id="verifyMeta" class="ghost">Verify Meta</button>
            <button id="verifyGa4" class="ghost">Verify GA4</button>
            <button id="exportChat" class="ghost">Export</button>
          </div>
        </div>
      </aside>
      <button
        id="sidebarBackdrop"
        class="sidebar-backdrop"
        aria-label="Close sidebar"
        title="Close sidebar"
      ></button>

      <main class="main">
        <div class="topbar">
          <div class="topbar-left">
            <button id="toggleSidebar" class="ghost menu-btn" aria-label="Open sidebar" title="Menu">Menu</button>
            <div class="brand">
              <div class="title">Marketing AI Assistant</div>
              <div class="subtle">Premium local copilot for Meta and GA4 insights</div>
            </div>
          </div>
          <div class="row top-actions">
            <span id="lastUpdated" class="muted-pill">Updated: --</span>
            <button id="refreshKpi" class="ghost">Refresh</button>
            <button id="toggleCompact" class="ghost">Compact</button>
            <button id="renameChat" class="ghost">Rename</button>
            <button id="deleteChat" class="ghost">Delete</button>
            <button id="regenerate" class="ghost">Regenerate</button>
          </div>
        </div>

        <div id="kpiSection" class="kpi-tabs-wrap">
          <div class="kpi-toolbar">
            <div class="left">
              <span class="muted-pill">Brand Dashboard</span>
            </div>
            <div class="right">
              <span id="tabAccountHint" class="muted-pill">Account: --</span>
            </div>
          </div>
          <div class="kpi-tabs">
            <button id="tabCoxwellMeta" class="kpi-tab active">Coxwell Meta Ads</button>
            <button id="tabCoxwellIg" class="kpi-tab">Coxwell Instagram</button>
            <button id="tabCoxwellGa4" class="kpi-tab">Coxwell GA4</button>
            <button id="tabAltisMeta" class="kpi-tab">Altis Meta Ads</button>
            <button id="tabAltisIg" class="kpi-tab">Altis Instagram</button>
            <button id="tabAltisGa4" class="kpi-tab">Altis GA4</button>
          </div>
          <div id="tabHint" class="tab-hint">Coxwell Meta Ads overview</div>

          <div id="panelCoxwellMeta" class="kpi-panel active">
            <div class="kpi meta-card"><div class="name" title="Meta spend for today">Spend (Today)</div><div id="tabCwMetaSpendToday" class="value">-</div></div>
            <div class="kpi meta-card"><div class="name" title="Meta spend over last 7 days">Spend (Last 7D)</div><div id="tabCwMetaSpend7d" class="value">-</div></div>
            <div class="kpi meta-card"><div class="name" title="Meta leads generated today">Leads (Today)</div><div id="tabCwMetaLeadsToday" class="value">-</div></div>
            <div class="kpi meta-card"><div class="name" title="Meta leads generated over last 7 days">Leads (Last 7D)</div><div id="tabCwMetaLeads7d" class="value">-</div></div>
            <div class="kpi meta-card"><div class="name" title="Top campaign by leads">Best Campaign</div><div id="tabCwMetaBestCampaign" class="value">-</div></div>
            <div class="kpi meta-card"><div class="name" title="Cost per lead for best campaign">Best Campaign CPL</div><div id="tabCwMetaBestCpl" class="value">-</div></div>
          </div>

          <div id="panelCoxwellIg" class="kpi-panel">
            <div class="kpi ig-card"><div class="name" title="Total Instagram followers">Followers</div><div id="tabCwIgFollowers" class="value">-</div></div>
            <div class="kpi ig-card"><div class="name" title="Accounts followed by this profile">Following</div><div id="tabCwIgFollowing" class="value">-</div></div>
            <div class="kpi ig-card"><div class="name" title="Total media posts on profile">Media Count</div><div id="tabCwIgMediaCount" class="value">-</div></div>
            <div class="kpi ig-card"><div class="name" title="Plays on best performing reel">Best Reel Plays</div><div id="tabCwIgBestPlays" class="value">-</div></div>
            <div class="kpi ig-card"><div class="name" title="Reach on best performing reel">Best Reel Reach</div><div id="tabCwIgBestReach" class="value">-</div></div>
            <div class="kpi ig-card"><div class="name" title="Saves on best performing reel">Best Reel Saves</div><div id="tabCwIgBestSaves" class="value">-</div></div>
          </div>

          <div id="panelCoxwellGa4" class="kpi-panel">
            <div class="kpi"><div class="name" title="Realtime/current active users">Active Users (Today)</div><div id="tabCwGa4ActiveToday" class="value">-</div></div>
            <div class="kpi"><div class="name" title="Active users yesterday">Active Users (Yesterday)</div><div id="tabCwGa4ActiveYesterday" class="value">-</div></div>
            <div class="kpi"><div class="name" title="Active users over last 7 days">Active Users (Last 7D)</div><div id="tabCwGa4Active7d" class="value">-</div></div>
            <div class="kpi"><div class="name" title="Sessions today">Sessions (Today)</div><div id="tabCwGa4SessionsToday" class="value">-</div></div>
            <div class="kpi"><div class="name" title="Sessions over last 7 days">Sessions (Last 7D)</div><div id="tabCwGa4Sessions7d" class="value">-</div></div>
            <div class="kpi"><div class="name" title="Sessions this month">Sessions (Month)</div><div id="tabCwGa4SessionsMonth" class="value">-</div></div>
          </div>

          <div id="panelAltisMeta" class="kpi-panel">
            <div class="kpi meta-card"><div class="name" title="Meta spend for today">Spend (Today)</div><div id="tabAltisMetaSpendToday" class="value">-</div></div>
            <div class="kpi meta-card"><div class="name" title="Meta spend over last 7 days">Spend (Last 7D)</div><div id="tabAltisMetaSpend7d" class="value">-</div></div>
            <div class="kpi meta-card"><div class="name" title="Meta leads generated today">Leads (Today)</div><div id="tabAltisMetaLeadsToday" class="value">-</div></div>
            <div class="kpi meta-card"><div class="name" title="Meta leads generated over last 7 days">Leads (Last 7D)</div><div id="tabAltisMetaLeads7d" class="value">-</div></div>
            <div class="kpi meta-card"><div class="name" title="Top campaign by leads">Best Campaign</div><div id="tabAltisMetaBestCampaign" class="value">-</div></div>
            <div class="kpi meta-card"><div class="name" title="Cost per lead for best campaign">Best Campaign CPL</div><div id="tabAltisMetaBestCpl" class="value">-</div></div>
          </div>

          <div id="panelAltisIg" class="kpi-panel">
            <div class="kpi ig-card"><div class="name" title="Total Instagram followers">Followers</div><div id="tabAltisIgFollowers" class="value">-</div></div>
            <div class="kpi ig-card"><div class="name" title="Accounts followed by this profile">Following</div><div id="tabAltisIgFollowing" class="value">-</div></div>
            <div class="kpi ig-card"><div class="name" title="Total media posts on profile">Media Count</div><div id="tabAltisIgMediaCount" class="value">-</div></div>
            <div class="kpi ig-card"><div class="name" title="Plays on best performing reel">Best Reel Plays</div><div id="tabAltisIgBestPlays" class="value">-</div></div>
            <div class="kpi ig-card"><div class="name" title="Reach on best performing reel">Best Reel Reach</div><div id="tabAltisIgBestReach" class="value">-</div></div>
            <div class="kpi ig-card"><div class="name" title="Saves on best performing reel">Best Reel Saves</div><div id="tabAltisIgBestSaves" class="value">-</div></div>
          </div>

          <div id="panelAltisGa4" class="kpi-panel">
            <div class="kpi"><div class="name" title="Realtime/current active users">Active Users (Today)</div><div id="tabAltisGa4ActiveToday" class="value">-</div></div>
            <div class="kpi"><div class="name" title="Active users yesterday">Active Users (Yesterday)</div><div id="tabAltisGa4ActiveYesterday" class="value">-</div></div>
            <div class="kpi"><div class="name" title="Active users over last 7 days">Active Users (Last 7D)</div><div id="tabAltisGa4Active7d" class="value">-</div></div>
            <div class="kpi"><div class="name" title="Sessions today">Sessions (Today)</div><div id="tabAltisGa4SessionsToday" class="value">-</div></div>
            <div class="kpi"><div class="name" title="Sessions over last 7 days">Sessions (Last 7D)</div><div id="tabAltisGa4Sessions7d" class="value">-</div></div>
            <div class="kpi"><div class="name" title="Sessions this month">Sessions (Month)</div><div id="tabAltisGa4SessionsMonth" class="value">-</div></div>
          </div>
        </div>

        <div class="kpis legacy-kpis">
          <div class="kpi"><div class="name">Meta Leads (Today)</div><div id="kpiLeads" class="value">-</div></div>
          <div class="kpi"><div class="name">Meta Leads (Last 30D)</div><div id="kpiLeads30d" class="value">-</div></div>
          <div class="kpi"><div class="name">Meta Spend (Today)</div><div id="kpiSpendToday" class="value">-</div></div>
          <div class="kpi"><div class="name">Meta Spend (Month)</div><div id="kpiSpendMonth" class="value">-</div></div>
          <div class="kpi"><div class="name">GA4 Active Users</div><div id="kpiUsers" class="value">-</div></div>
          <div class="kpi"><div class="name">GA4 Sessions (Today)</div><div id="kpiSessionsToday" class="value">-</div></div>
          <div class="kpi"><div class="name">Best Campaign</div><div id="kpiBestCampaign" class="value">-</div></div>
          <div class="kpi"><div class="name">Best Campaign CPL</div><div id="kpiBestCpl" class="value">-</div></div>
          <div class="kpi"><div class="name">Weakest Campaign</div><div id="kpiWorstCampaign" class="value">-</div></div>
          <div class="kpi"><div class="name">Meta Leads (Last 7D)</div><div id="kpiLeads7d" class="value">-</div></div>
          <div class="kpi"><div class="name">Meta Spend (Last 7D)</div><div id="kpiSpend7d" class="value">-</div></div>
          <div class="kpi"><div class="name">GA4 Sessions (Last 7D)</div><div id="kpiGa4Sessions7d" class="value">-</div></div>
          <div class="kpi"><div class="name">IG Followers</div><div id="kpiIgFollowers" class="value">-</div></div>
          <div class="kpi"><div class="name">Best Reel (Overall)</div><div id="kpiIgBestReel" class="value">-</div></div>
        </div>
        <div class="statusbar">
          <div id="statusDot" class="status-dot"></div>
          <div id="statusText" class="status-text">Checking connection...</div>
          <div class="status-spacer"></div>
          <div id="ga4Badge" class="ga4-badge">GA4: checking...</div>
        </div>
        <div id="alertStrip" class="alert-strip">
          <span class="alert-dot"></span>
          <span id="alertText">No alerts</span>
        </div>

        <div id="chatSection" class="chat-wrap">
          <div id="chat" class="chat"></div>
          <div class="composer">
            <div class="row">
              <input id="msg" placeholder="Ask for performance insights... (Ctrl+K to focus)" />
              <button id="send">Send</button>
            </div>
            <div class="chips" id="chips"></div>
            <div class="subtle">Tips: supports markdown tables/lists, copy, history, regenerate, export</div>
          </div>
        </div>
      </main>
    </div>
    <nav id="mobileNav" class="mobile-nav" aria-label="Mobile navigation">
      <button id="navKpi" type="button" class="active">KPIs</button>
      <button id="navChat" type="button">Chat</button>
      <button id="navSettings" type="button">Settings</button>
    </nav>
    <button id="scrollTopBtn" class="scroll-top-btn" title="Back to top">Top</button>

    <script>
      const STORAGE_KEY = "mai-conversations-v4";
      const STORAGE_CURR = "mai-current-conv-id-v4";
      const STORAGE_FOLDERS = "mai-folders-v1";
      const STORAGE_ACTIVE_FOLDER = "mai-active-folder-v1";
      const LEGACY_STORAGE_KEYS = ["mai-conversations-v3", "mai-conversations-v2", "mai-conversations"];
      const LEGACY_CURR_KEYS = ["mai-current-conv-id", "mai-current-conv-id-v3", "mai-current-conv-id-v2"];
      const SUGGESTIONS = [
        "How many Meta leads today?",
        "How many Meta leads in last 30 days?",
        "How much Meta spend today?",
        "Meta spend this month",
        "Which campaign is performing best today?",
        "GA4 active users today",
        "GA4 active users yesterday",
        "GA4 active users last 7 days",
        "GA4 sessions today",
        "What is my 5-day ad spend estimate?",
        "Which ad is performing very poor and why?",
        "Compare Meta spend today vs yesterday",
        "What is my CPL trend this week?",
        "Show me overall Meta + GA4 performance snapshot",
        "Give me top 3 actions to improve lead quality",
        "Where is budget getting wasted today?",
        "How can I reduce CPL from today data?",
      ];

      const el = {
        chat: document.getElementById("chat"),
        msg: document.getElementById("msg"),
        send: document.getElementById("send"),
        regen: document.getElementById("regenerate"),
        clear: document.getElementById("clearChat"),
        newChat: document.getElementById("newChat"),
        newFolder: document.getElementById("newFolder"),
        renameFolder: document.getElementById("renameFolder"),
        deleteFolder: document.getElementById("deleteFolder"),
        folderList: document.getElementById("folderList"),
        rename: document.getElementById("renameChat"),
        del: document.getElementById("deleteChat"),
        convList: document.getElementById("convList"),
        search: document.getElementById("searchConv"),
        backendUrl: document.getElementById("backendUrl"),
        apiKey: document.getElementById("apiKey"),
        metaAccount: document.getElementById("metaAccount"),
        saveCfg: document.getElementById("saveCfg"),
        verifyMeta: document.getElementById("verifyMeta"),
        verifyGa4: document.getElementById("verifyGa4"),
        export: document.getElementById("exportChat"),
        refreshKpi: document.getElementById("refreshKpi"),
        toggleCompact: document.getElementById("toggleCompact"),
        lastUpdated: document.getElementById("lastUpdated"),
        tabHint: document.getElementById("tabHint"),
        tabAccountHint: document.getElementById("tabAccountHint"),
        alertStrip: document.getElementById("alertStrip"),
        alertText: document.getElementById("alertText"),
        chips: document.getElementById("chips"),
        kpiLeads: document.getElementById("kpiLeads"),
        kpiLeads30d: document.getElementById("kpiLeads30d"),
        kpiLeads7d: document.getElementById("kpiLeads7d"),
        kpiSpendToday: document.getElementById("kpiSpendToday"),
        kpiSpendMonth: document.getElementById("kpiSpendMonth"),
        kpiSpend7d: document.getElementById("kpiSpend7d"),
        kpiUsers: document.getElementById("kpiUsers"),
        kpiSessionsToday: document.getElementById("kpiSessionsToday"),
        kpiGa4Sessions7d: document.getElementById("kpiGa4Sessions7d"),
        kpiBestCampaign: document.getElementById("kpiBestCampaign"),
        kpiBestCpl: document.getElementById("kpiBestCpl"),
        kpiWorstCampaign: document.getElementById("kpiWorstCampaign"),
        kpiIgFollowers: document.getElementById("kpiIgFollowers"),
        kpiIgBestReel: document.getElementById("kpiIgBestReel"),
        tabCoxwellMeta: document.getElementById("tabCoxwellMeta"),
        tabCoxwellIg: document.getElementById("tabCoxwellIg"),
        tabCoxwellGa4: document.getElementById("tabCoxwellGa4"),
        tabAltisMeta: document.getElementById("tabAltisMeta"),
        tabAltisIg: document.getElementById("tabAltisIg"),
        tabAltisGa4: document.getElementById("tabAltisGa4"),
        panelCoxwellMeta: document.getElementById("panelCoxwellMeta"),
        panelCoxwellIg: document.getElementById("panelCoxwellIg"),
        panelCoxwellGa4: document.getElementById("panelCoxwellGa4"),
        panelAltisMeta: document.getElementById("panelAltisMeta"),
        panelAltisIg: document.getElementById("panelAltisIg"),
        panelAltisGa4: document.getElementById("panelAltisGa4"),
        tabCwMetaSpendToday: document.getElementById("tabCwMetaSpendToday"),
        tabCwMetaSpend7d: document.getElementById("tabCwMetaSpend7d"),
        tabCwMetaLeadsToday: document.getElementById("tabCwMetaLeadsToday"),
        tabCwMetaLeads7d: document.getElementById("tabCwMetaLeads7d"),
        tabCwMetaBestCampaign: document.getElementById("tabCwMetaBestCampaign"),
        tabCwMetaBestCpl: document.getElementById("tabCwMetaBestCpl"),
        tabCwIgFollowers: document.getElementById("tabCwIgFollowers"),
        tabCwIgFollowing: document.getElementById("tabCwIgFollowing"),
        tabCwIgMediaCount: document.getElementById("tabCwIgMediaCount"),
        tabCwIgBestPlays: document.getElementById("tabCwIgBestPlays"),
        tabCwIgBestReach: document.getElementById("tabCwIgBestReach"),
        tabCwIgBestSaves: document.getElementById("tabCwIgBestSaves"),
        tabCwGa4ActiveToday: document.getElementById("tabCwGa4ActiveToday"),
        tabCwGa4ActiveYesterday: document.getElementById("tabCwGa4ActiveYesterday"),
        tabCwGa4Active7d: document.getElementById("tabCwGa4Active7d"),
        tabCwGa4SessionsToday: document.getElementById("tabCwGa4SessionsToday"),
        tabCwGa4Sessions7d: document.getElementById("tabCwGa4Sessions7d"),
        tabCwGa4SessionsMonth: document.getElementById("tabCwGa4SessionsMonth"),
        tabAltisMetaSpendToday: document.getElementById("tabAltisMetaSpendToday"),
        tabAltisMetaSpend7d: document.getElementById("tabAltisMetaSpend7d"),
        tabAltisMetaLeadsToday: document.getElementById("tabAltisMetaLeadsToday"),
        tabAltisMetaLeads7d: document.getElementById("tabAltisMetaLeads7d"),
        tabAltisMetaBestCampaign: document.getElementById("tabAltisMetaBestCampaign"),
        tabAltisMetaBestCpl: document.getElementById("tabAltisMetaBestCpl"),
        tabAltisIgFollowers: document.getElementById("tabAltisIgFollowers"),
        tabAltisIgFollowing: document.getElementById("tabAltisIgFollowing"),
        tabAltisIgMediaCount: document.getElementById("tabAltisIgMediaCount"),
        tabAltisIgBestPlays: document.getElementById("tabAltisIgBestPlays"),
        tabAltisIgBestReach: document.getElementById("tabAltisIgBestReach"),
        tabAltisIgBestSaves: document.getElementById("tabAltisIgBestSaves"),
        tabAltisGa4ActiveToday: document.getElementById("tabAltisGa4ActiveToday"),
        tabAltisGa4ActiveYesterday: document.getElementById("tabAltisGa4ActiveYesterday"),
        tabAltisGa4Active7d: document.getElementById("tabAltisGa4Active7d"),
        tabAltisGa4SessionsToday: document.getElementById("tabAltisGa4SessionsToday"),
        tabAltisGa4Sessions7d: document.getElementById("tabAltisGa4Sessions7d"),
        tabAltisGa4SessionsMonth: document.getElementById("tabAltisGa4SessionsMonth"),
        statusDot: document.getElementById("statusDot"),
        statusText: document.getElementById("statusText"),
        ga4Badge: document.getElementById("ga4Badge"),
        scrollTopBtn: document.getElementById("scrollTopBtn"),
        toggleSidebar: document.getElementById("toggleSidebar"),
        sidebarBackdrop: document.getElementById("sidebarBackdrop"),
        main: document.querySelector(".main"),
        navKpi: document.getElementById("navKpi"),
        navChat: document.getElementById("navChat"),
        navSettings: document.getElementById("navSettings"),
        kpiSection: document.getElementById("kpiSection"),
        chatSection: document.getElementById("chatSection"),
      };

      el.backendUrl.value = localStorage.getItem("backend-url") || window.location.origin;
      el.apiKey.value = localStorage.getItem("x-api-key") || "";
      el.metaAccount.value = localStorage.getItem("meta-account-id") || "";

      function isMobileViewport() {
        return window.matchMedia("(max-width: 900px)").matches;
      }

      function setSidebarOpen(open) {
        document.body.classList.toggle("sidebar-open", !!open);
      }

      function closeSidebarOnMobile() {
        if (isMobileViewport()) setSidebarOpen(false);
      }

      function setMobileNavActive(key) {
        const pairs = [
          ["kpi", el.navKpi],
          ["chat", el.navChat],
          ["settings", el.navSettings],
        ];
        for (const [k, btn] of pairs) {
          if (!btn) continue;
          if (k === key) btn.classList.add("active");
          else btn.classList.remove("active");
        }
      }

      function scrollToSection(target) {
        if (!target) return;
        target.scrollIntoView({ behavior: "smooth", block: "start" });
      }

      let conversations = [];
      let folders = [];
      let activeFolderId = localStorage.getItem(STORAGE_ACTIVE_FOLDER) || "all";
      let currentConversationId = localStorage.getItem(STORAGE_CURR) || "";
      let editingMessageId = null;
      let openConvMenuId = null;
      let metaAccounts = [];
      let activeKpiTab = localStorage.getItem("mai-kpi-tab") || "coxwell-meta";
      let compactMode = localStorage.getItem("mai-compact") === "1";
      const kpiPrevValue = new Map();
      const TAB_QUERIES = {
        "coxwell-meta": [
          "Coxwell meta spend today",
          "Coxwell meta leads last 7 days",
          "Coxwell best campaign today",
        ],
        "coxwell-ig": [
          "Coxwell instagram followers",
          "Coxwell best reel overall",
          "Coxwell instagram reel reach",
        ],
        "coxwell-ga4": [
          "Coxwell ga4 active users today",
          "Coxwell ga4 sessions today",
          "Coxwell ga4 sessions this month",
        ],
        "altis-meta": [
          "Altis meta spend today",
          "Altis meta leads last 7 days",
          "Altis best campaign today",
        ],
        "altis-ig": [
          "Altis instagram followers",
          "Altis best reel overall",
          "Altis instagram reel reach",
        ],
        "altis-ga4": [
          "Altis ga4 active users today",
          "Altis ga4 sessions today",
          "Altis ga4 sessions this month",
        ],
      };

      function uid() {
        return `${Date.now()}_${Math.random().toString(16).slice(2)}`;
      }
      function nowIso() {
        return new Date().toISOString();
      }
      function fmtTime(iso) {
        return new Date(iso).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
      }
      function escapeHtml(str) {
        return String(str)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll("\"", "&quot;")
          .replaceAll("'", "&#39;");
      }

      function formatInline(text) {
        return text
          .replace(/`([^`]+)`/g, "<code>$1</code>")
          .replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>")
          .replace(/\*(.+?)\*/g, "<em>$1</em>");
      }
      function toCells(row) {
        return row
          .split("|")
          .map((c) => c.trim())
          .filter((c, i, arr) => !(i === 0 && c === "") && !(i === arr.length - 1 && c === ""));
      }
      function renderMarkdown(raw) {
        if (!raw) return "";
        const codeBlocks = [];
        const tokenized = raw.replace(/```([\w-]*)\n([\s\S]*?)```/g, (_, lang, code) => {
          const idx = codeBlocks.push({ lang: lang || "", code }) - 1;
          return `@@CODE_BLOCK_${idx}@@`;
        });
        const safe = escapeHtml(tokenized);
        const lines = safe.split("\n");
        const out = [];
        for (let i = 0; i < lines.length; i++) {
          const line = lines[i];
          const next = lines[i + 1] || "";

          if (line.includes("|") && /^\s*\|?[-:\s|]+\|?\s*$/.test(next)) {
            const rows = [line];
            i += 2;
            while (i < lines.length && lines[i].includes("|")) {
              rows.push(lines[i]);
              i++;
            }
            i--;
            const header = toCells(rows[0]);
            const body = rows.slice(1).map(toCells);
            out.push("<table><thead><tr>" + header.map((h) => `<th>${formatInline(h)}</th>`).join("") + "</tr></thead><tbody>");
            body.forEach((r) => out.push("<tr>" + r.map((c) => `<td>${formatInline(c)}</td>`).join("") + "</tr>"));
            out.push("</tbody></table>");
            continue;
          }

          if (/^\s*[-*]\s+/.test(line)) {
            const items = [line.replace(/^\s*[-*]\s+/, "")];
            i++;
            while (i < lines.length && /^\s*[-*]\s+/.test(lines[i])) {
              items.push(lines[i].replace(/^\s*[-*]\s+/, ""));
              i++;
            }
            i--;
            out.push("<ul>" + items.map((it) => `<li>${formatInline(it)}</li>`).join("") + "</ul>");
            continue;
          }

          if (/^\s*\d+\.\s+/.test(line)) {
            const items = [line.replace(/^\s*\d+\.\s+/, "")];
            i++;
            while (i < lines.length && /^\s*\d+\.\s+/.test(lines[i])) {
              items.push(lines[i].replace(/^\s*\d+\.\s+/, ""));
              i++;
            }
            i--;
            out.push("<ol>" + items.map((it) => `<li>${formatInline(it)}</li>`).join("") + "</ol>");
            continue;
          }

          if (!line.trim()) {
            out.push("");
            continue;
          }
          out.push(`<p>${formatInline(line)}</p>`);
        }

        let html = out.join("\n");
        html = html.replace(/@@CODE_BLOCK_(\d+)@@/g, (_, n) => {
          const b = codeBlocks[Number(n)];
          const cls = b.lang ? ` class="language-${escapeHtml(b.lang)}"` : "";
          return `<pre><code${cls}>${escapeHtml(b.code)}</code></pre>`;
        });
        return html;
      }

      function getBackendBase() {
        const fromInput = (el.backendUrl?.value || "").trim();
        const fromStorage = (localStorage.getItem("backend-url") || "").trim();
        return (fromInput || fromStorage || window.location.origin).replace(/\/+$/, "");
      }

      function getApiKey() {
        const fromInput = (el.apiKey?.value || "").trim();
        const fromStorage = (localStorage.getItem("x-api-key") || "").trim();
        return fromInput || fromStorage;
      }

      function getMetaAccountId() {
        const fromInput = (el.metaAccount?.value || "").trim();
        const fromStorage = (localStorage.getItem("meta-account-id") || "").trim();
        return fromInput || fromStorage;
      }

      function resolveUrl(path) {
        const base = getBackendBase();
        if (!base) return path;
        if (/^https?:\/\//i.test(path)) return path;
        return base + path;
      }
      async function postJson(url, body) {
        const key = getApiKey();
        const accountId = getMetaAccountId();
        let res;
        try {
          res = await fetch(resolveUrl(url), {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              ...(key ? { "x-api-key": key } : {}),
              ...(accountId ? { "x-meta-account-id": accountId } : {}),
            },
            body: JSON.stringify(body),
          });
        } catch {
          return { ok: false, status: 0, raw: "Network error. Check backend URL and server status.", json: null };
        }
        const text = await res.text();
        let json = null;
        try {
          json = JSON.parse(text);
        } catch {}
        if (!res.ok) return { ok: false, status: res.status, raw: text, json };
        return { ok: true, json };
      }

      async function getJson(url) {
        const key = getApiKey();
        const accountId = getMetaAccountId();
        try {
          const res = await fetch(resolveUrl(url), {
            method: "GET",
            headers: {
              ...(key ? { "x-api-key": key } : {}),
              ...(accountId ? { "x-meta-account-id": accountId } : {}),
            },
          });
          const text = await res.text();
          let json = null;
          try {
            json = JSON.parse(text);
          } catch {}
          if (!res.ok) return { ok: false, status: res.status, raw: text, json };
          return { ok: true, json };
        } catch {
          return { ok: false, status: 0, raw: "Network error", json: null };
        }
      }

      function getCurrentConversation() {
        return conversations.find((c) => c.id === currentConversationId) || null;
      }
      function getLastUserPrompt(c) {
        if (!c) return "";
        for (let i = c.messages.length - 1; i >= 0; i--) {
          if (c.messages[i].role === "user") return c.messages[i].text;
        }
        return "";
      }
      function buildTitle(messages) {
        const first = messages.find((m) => m.role === "user");
        if (!first) return "New chat";
        const t = first.text.trim();
        return t.length > 38 ? t.slice(0, 38) + "..." : t;
      }

      function persist() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(conversations));
        localStorage.setItem(STORAGE_FOLDERS, JSON.stringify(folders));
        localStorage.setItem(STORAGE_ACTIVE_FOLDER, activeFolderId);
        localStorage.setItem(STORAGE_CURR, currentConversationId);
      }
      function createConversation(seed = "") {
        const c = {
          id: uid(),
          title: seed ? seed.slice(0, 38) + (seed.length > 38 ? "..." : "") : "New chat",
          createdAt: nowIso(),
          updatedAt: nowIso(),
          messages: [],
          folderId: activeFolderId === "all" ? null : activeFolderId,
        };
        conversations.unshift(c);
        currentConversationId = c.id;
        persist();
        renderConversationList();
        renderCurrentConversation();
      }
      function ensureConversation() {
        if (!conversations.length) createConversation();
        if (!getCurrentConversation()) currentConversationId = conversations[0].id;
      }
      function load() {
        try {
          let raw = localStorage.getItem(STORAGE_KEY);
          let curr = localStorage.getItem(STORAGE_CURR) || "";

          if (!raw) {
            for (const key of LEGACY_STORAGE_KEYS) {
              const legacy = localStorage.getItem(key);
              if (legacy) {
                raw = legacy;
                localStorage.setItem(STORAGE_KEY, legacy);
                break;
              }
            }
          }

          if (!curr) {
            for (const key of LEGACY_CURR_KEYS) {
              const legacyCurr = localStorage.getItem(key);
              if (legacyCurr) {
                curr = legacyCurr;
                localStorage.setItem(STORAGE_CURR, legacyCurr);
                break;
              }
            }
          }

          conversations = raw ? JSON.parse(raw) : [];
          if (curr) currentConversationId = curr;
          if (!Array.isArray(conversations)) conversations = [];
          const rawFolders = localStorage.getItem(STORAGE_FOLDERS);
          folders = rawFolders ? JSON.parse(rawFolders) : [];
          if (!Array.isArray(folders)) folders = [];
          if (activeFolderId !== "all" && !folders.some((f) => String(f.id) === String(activeFolderId))) {
            activeFolderId = "all";
          }
        } catch {
          conversations = [];
          folders = [];
        }
        // Ensure config is persisted even if user has typed but not clicked Save.
        if (!localStorage.getItem("backend-url") && (el.backendUrl.value || "").trim()) {
          localStorage.setItem("backend-url", el.backendUrl.value.trim());
        }
        if (!localStorage.getItem("x-api-key") && (el.apiKey.value || "").trim()) {
          localStorage.setItem("x-api-key", el.apiKey.value.trim());
        }
        if (!localStorage.getItem("meta-account-id") && (el.metaAccount.value || "").trim()) {
          localStorage.setItem("meta-account-id", el.metaAccount.value.trim());
        }
        ensureConversation();
      }

      async function loadMetaAccounts() {
        const resp = await getJson("/api/meta/accounts");
        if (!resp.ok) return;
        const accounts = Array.isArray(resp.json?.accounts) ? resp.json.accounts : [];
        metaAccounts = accounts;
        const defaultAccount = String(resp.json?.default_account || "");
        const selected = getMetaAccountId();

        const opts = [`<option value="">Default account</option>`];
        for (const account of accounts) {
          const safe = escapeHtml(String(account));
          opts.push(`<option value="${safe}">${safe}</option>`);
        }
        el.metaAccount.innerHTML = opts.join("");

        const nextValue =
          (selected && accounts.includes(selected) && selected) ||
          (defaultAccount && accounts.includes(defaultAccount) && defaultAccount) ||
          "";
        el.metaAccount.value = nextValue;
        localStorage.setItem("meta-account-id", nextValue);
      }

      function setActiveKpiTab(tabKey) {
        activeKpiTab = tabKey;
        localStorage.setItem("mai-kpi-tab", tabKey);
        const tabs = [
          ["coxwell-meta", el.tabCoxwellMeta, el.panelCoxwellMeta],
          ["coxwell-ig", el.tabCoxwellIg, el.panelCoxwellIg],
          ["coxwell-ga4", el.tabCoxwellGa4, el.panelCoxwellGa4],
          ["altis-meta", el.tabAltisMeta, el.panelAltisMeta],
          ["altis-ig", el.tabAltisIg, el.panelAltisIg],
          ["altis-ga4", el.tabAltisGa4, el.panelAltisGa4],
        ];
        for (const [key, btn, panel] of tabs) {
          if (!btn || !panel) continue;
          if (key === tabKey) {
            btn.classList.add("active");
            panel.classList.add("active");
          } else {
            btn.classList.remove("active");
            panel.classList.remove("active");
          }
        }
        const tabNames = {
          "coxwell-meta": "Coxwell Meta Ads overview",
          "coxwell-ig": "Coxwell Instagram overview",
          "coxwell-ga4": "Coxwell GA4 overview",
          "altis-meta": "Altis Meta Ads overview",
          "altis-ig": "Altis Instagram overview",
          "altis-ga4": "Altis GA4 overview",
        };
        if (el.tabHint) el.tabHint.textContent = tabNames[tabKey] || "Brand overview";
        renderChips();
      }

      function getBrandAccounts() {
        const list = Array.isArray(metaAccounts) ? metaAccounts : [];
        return {
          coxwell: String(list[0] || ""),
          altis: String(list[1] || list[0] || ""),
        };
      }

      function setKpiCardMetric(element, rawValue) {
        if (!element) return;
        element.textContent = rawValue;
        const card = element.closest(".kpi");
        if (!card) return;

        let extra = card.querySelector(".kpi-extra");
        if (!extra) {
          extra = document.createElement("div");
          extra.className = "kpi-extra";
          extra.innerHTML = '<span class="kpi-delta">--</span><span class="kpi-spark"></span>';
          card.appendChild(extra);
        }
        const deltaEl = extra.querySelector(".kpi-delta");
        const sparkEl = extra.querySelector(".kpi-spark");
        const key = element.id;
        const prev = Number(kpiPrevValue.get(key));
        const current = Number(String(rawValue).replace(/[^0-9.-]/g, ""));
        if (Number.isFinite(current) && Number.isFinite(prev) && prev !== 0) {
          const pct = ((current - prev) / Math.abs(prev)) * 100;
          const sign = pct > 0 ? "+" : "";
          deltaEl.textContent = `${sign}${pct.toFixed(1)}%`;
          deltaEl.className = "kpi-delta " + (pct > 0 ? "up" : pct < 0 ? "down" : "");
        } else {
          deltaEl.textContent = "new";
          deltaEl.className = "kpi-delta";
        }

        if (Number.isFinite(current)) {
          kpiPrevValue.set(key, current);
          if (sparkEl) {
            const seed = Math.abs(Math.floor(current)) % 7;
            const vals = Array.from({ length: 7 }).map((_, i) =>
              Math.max(2, Math.min(14, Math.round(4 + ((i + seed) % 7) + (current % 9) / 2)))
            );
            sparkEl.innerHTML = vals.map((v) => `<i style="height:${v}px"></i>`).join("");
          }
        } else if (sparkEl) {
          sparkEl.innerHTML = "";
        }
      }

      function setKpiCardSubvalue(element, rawValue) {
        if (!element) return;
        const card = element.closest(".kpi");
        if (!card) return;
        let sub = card.querySelector(".subvalue");
        if (!sub) {
          sub = document.createElement("div");
          sub.className = "subvalue";
          card.appendChild(sub);
        }
        const text = String(rawValue || "").trim();
        sub.textContent = text || " ";
        if (text) sub.title = text;
        else sub.removeAttribute("title");
      }

      function formatReelLabel(row) {
        if (!row || typeof row !== "object") return "";
        const caption = String(row.caption || "").trim();
        if (caption) {
          return caption;
        }
        const id = String(row.media_id || "").trim();
        return id ? `Reel ${id}` : "";
      }

      function showAlert(message) {
        if (!el.alertStrip || !el.alertText) return;
        if (!message) {
          el.alertStrip.classList.remove("show");
          return;
        }
        el.alertText.textContent = message;
        el.alertStrip.classList.add("show");
      }

      function setLastUpdated() {
        if (!el.lastUpdated) return;
        const now = new Date();
        el.lastUpdated.textContent = `Updated: ${now.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })}`;
      }

      function applyCompactMode() {
        if (compactMode) document.body.classList.add("compact");
        else document.body.classList.remove("compact");
        if (el.toggleCompact) el.toggleCompact.textContent = compactMode ? "Comfortable" : "Compact";
      }

      function getFolderName(folderId) {
        if (!folderId) return "Unfiled";
        const f = folders.find((x) => x.id === folderId);
        return f?.name || "Unknown folder";
      }

      function renderFolderList() {
        el.folderList.innerHTML = "";
        const items = [{ id: "all", name: "All" }, ...folders];
        items.forEach((f) => {
          const b = document.createElement("button");
          b.className = "folder-chip" + (String(activeFolderId) === String(f.id) ? " active" : "");
          b.textContent = f.name;
          b.onclick = () => {
            activeFolderId = String(f.id);
            persist();
            renderFolderList();
            renderConversationList();
          };
          el.folderList.appendChild(b);
        });
      }

      function createFolder() {
        const name = prompt("Folder name");
        if (!name || !name.trim()) return;
        const n = name.trim();
        if (folders.some((f) => f.name.toLowerCase() === n.toLowerCase())) return;
        const folder = { id: uid(), name: n, createdAt: nowIso(), updatedAt: nowIso() };
        folders.unshift(folder);
        activeFolderId = folder.id;
        persist();
        renderFolderList();
        renderConversationList();
      }

      function renameActiveFolder() {
        if (activeFolderId === "all") return;
        const folder = folders.find((f) => f.id === activeFolderId);
        if (!folder) return;
        const next = prompt("Rename folder", folder.name);
        if (!next || !next.trim()) return;
        folder.name = next.trim();
        folder.updatedAt = nowIso();
        persist();
        renderFolderList();
        renderConversationList();
      }

      function deleteActiveFolder() {
        if (activeFolderId === "all") return;
        const folder = folders.find((f) => f.id === activeFolderId);
        if (!folder) return;
        if (!confirm(`Delete folder "${folder.name}"? Chats will move to Unfiled.`)) return;
        conversations.forEach((c) => {
          if (c.folderId === folder.id) c.folderId = null;
        });
        folders = folders.filter((f) => f.id !== folder.id);
        activeFolderId = "all";
        persist();
        renderFolderList();
        renderConversationList();
      }

      function moveConversationToFolder(conversationId) {
        const c = conversations.find((x) => x.id === conversationId);
        if (!c) return;
        const choices = ["0) Unfiled", ...folders.map((f, i) => `${i + 1}) ${f.name}`)].join("\n");
        const pick = prompt(`Move chat to folder:\n${choices}`, "0");
        if (pick === null) return;
        const idx = Number(pick);
        if (!Number.isFinite(idx)) return;
        if (idx === 0) c.folderId = null;
        else if (idx >= 1 && idx <= folders.length) c.folderId = folders[idx - 1].id;
        c.updatedAt = nowIso();
        persist();
        renderConversationList();
      }

      function renameConversationById(conversationId) {
        const c = conversations.find((x) => x.id === conversationId);
        if (!c) return;
        const name = prompt("Rename chat", c.title);
        if (!name || !name.trim()) return;
        c.title = name.trim();
        c.updatedAt = nowIso();
        persist();
        renderConversationList();
      }

      function deleteConversationById(conversationId) {
        conversations = conversations.filter((x) => x.id !== conversationId);
        if (!conversations.length) createConversation();
        else if (currentConversationId === conversationId) currentConversationId = conversations[0].id;
        persist();
        renderConversationList();
        renderCurrentConversation();
      }

      function renderConversationList() {
        const query = el.search.value.trim().toLowerCase();
        el.convList.innerHTML = "";
        conversations
          .filter((c) => {
            const matchesQuery = !query || c.title.toLowerCase().includes(query);
            const matchesFolder =
              activeFolderId === "all" || String(c.folderId || "") === String(activeFolderId);
            return matchesQuery && matchesFolder;
          })
          .forEach((c) => {
            const row = document.createElement("div");
            row.className = "conv-row" + (c.id === currentConversationId ? " active" : "");

            const head = document.createElement("div");
            head.className = "conv-head";
            const openBtn = document.createElement("button");
            openBtn.className = "conv-open";
            openBtn.innerHTML = `<div class="t">${escapeHtml(c.title)}</div>`;
            openBtn.onclick = () => {
              currentConversationId = c.id;
              openConvMenuId = null;
              persist();
              renderConversationList();
              renderCurrentConversation();
            };

            const menuBtn = document.createElement("button");
            menuBtn.className = "kebab";
            menuBtn.textContent = "...";
            menuBtn.title = "More actions";
            menuBtn.onclick = (e) => {
              e.stopPropagation();
              openConvMenuId = openConvMenuId === c.id ? null : c.id;
              renderConversationList();
            };

            const meta = document.createElement("div");
            meta.className = "d";
            meta.textContent = `${new Date(c.updatedAt).toLocaleString()}  ${getFolderName(c.folderId)}`;

            const menu = document.createElement("div");
            menu.className = "conv-menu" + (openConvMenuId === c.id ? " show" : "");

            const renameBtn = document.createElement("button");
            renameBtn.textContent = "Rename";
            renameBtn.onclick = (e) => {
              e.stopPropagation();
              openConvMenuId = null;
              renameConversationById(c.id);
            };
            const moveBtn = document.createElement("button");
            moveBtn.textContent = "Move to folder";
            moveBtn.onclick = (e) => {
              e.stopPropagation();
              openConvMenuId = null;
              moveConversationToFolder(c.id);
            };

            const delBtn = document.createElement("button");
            delBtn.className = "danger";
            delBtn.textContent = "Delete";
            delBtn.onclick = (e) => {
              e.stopPropagation();
              openConvMenuId = null;
              deleteConversationById(c.id);
            };

            menu.appendChild(renameBtn);
            menu.appendChild(moveBtn);
            menu.appendChild(delBtn);
            head.appendChild(openBtn);
            head.appendChild(menuBtn);
            row.appendChild(head);
            row.appendChild(meta);
            row.appendChild(menu);
            el.convList.appendChild(row);
          });
      }

      function parseKpisFromText(text) {
        const s = String(text || "");
        const leads = s.match(/(\d+)\s+meta leads today/i);
        const spendToday = s.match(/spend today is\s+([^\.\n]+)/i);
        const spendMonth = s.match(/spend this month is\s+([^\.\n]+)/i);
        const users = s.match(/(\d+)\s+ga4 active users today/i);

        if (leads) el.kpiLeads.textContent = leads[1];
        if (spendToday) el.kpiSpendToday.textContent = spendToday[1].trim();
        if (spendMonth) el.kpiSpendMonth.textContent = spendMonth[1].trim();
        if (users) el.kpiUsers.textContent = users[1];
      }

      function formatCurrencyINR(n) {
        const num = Number(n);
        if (!Number.isFinite(num)) return "-";
        try {
          return new Intl.NumberFormat("en-IN", { style: "currency", currency: "INR", maximumFractionDigits: 0 }).format(num);
        } catch {
          return `INR ${Math.round(num)}`;
        }
      }

      function shortErrorText(resp) {
        if (resp?.ok) return "";
        const msg =
          resp?.json?.primary_error ||
          resp?.json?.error ||
          resp?.raw ||
          "Unknown error";
        const clean = String(msg).replace(/\s+/g, " ").trim();
        return clean.length > 180 ? clean.slice(0, 180) + "..." : clean;
      }

      function buildInstagramDiagnostic(brandLabel, accountId, overviewResp, bestReelResp) {
        const issues = [];
        if (!overviewResp?.ok) issues.push(`overview failed: ${shortErrorText(overviewResp)}`);
        if (!bestReelResp?.ok) issues.push(`best reel failed: ${shortErrorText(bestReelResp)}`);
        if (!issues.length) return "";
        return `Instagram ${brandLabel} (${accountId || "account not set"}): ${issues.join(" | ")}`;
      }

      function setKpiLoading() {
        el.kpiLeads.textContent = "...";
        el.kpiLeads30d.textContent = "...";
        el.kpiLeads7d.textContent = "...";
        el.kpiSpendToday.textContent = "...";
        el.kpiSpendMonth.textContent = "...";
        el.kpiSpend7d.textContent = "...";
        el.kpiUsers.textContent = "...";
        el.kpiSessionsToday.textContent = "...";
        el.kpiGa4Sessions7d.textContent = "...";
        el.kpiBestCampaign.textContent = "...";
        el.kpiBestCpl.textContent = "...";
        el.kpiWorstCampaign.textContent = "...";
        el.kpiIgFollowers.textContent = "...";
        el.kpiIgBestReel.textContent = "...";
        el.tabCwMetaSpendToday.textContent = "...";
        el.tabCwMetaSpend7d.textContent = "...";
        el.tabCwMetaLeadsToday.textContent = "...";
        el.tabCwMetaLeads7d.textContent = "...";
        el.tabCwMetaBestCampaign.textContent = "...";
        el.tabCwMetaBestCpl.textContent = "...";
        el.tabCwIgFollowers.textContent = "...";
        el.tabCwIgFollowing.textContent = "...";
        el.tabCwIgMediaCount.textContent = "...";
        el.tabCwIgBestPlays.textContent = "...";
        el.tabCwIgBestReach.textContent = "...";
        el.tabCwIgBestSaves.textContent = "...";
        el.tabCwGa4ActiveToday.textContent = "...";
        el.tabCwGa4ActiveYesterday.textContent = "...";
        el.tabCwGa4Active7d.textContent = "...";
        el.tabCwGa4SessionsToday.textContent = "...";
        el.tabCwGa4Sessions7d.textContent = "...";
        el.tabCwGa4SessionsMonth.textContent = "...";
        el.tabAltisMetaSpendToday.textContent = "...";
        el.tabAltisMetaSpend7d.textContent = "...";
        el.tabAltisMetaLeadsToday.textContent = "...";
        el.tabAltisMetaLeads7d.textContent = "...";
        el.tabAltisMetaBestCampaign.textContent = "...";
        el.tabAltisMetaBestCpl.textContent = "...";
        el.tabAltisIgFollowers.textContent = "...";
        el.tabAltisIgFollowing.textContent = "...";
        el.tabAltisIgMediaCount.textContent = "...";
        el.tabAltisIgBestPlays.textContent = "...";
        el.tabAltisIgBestReach.textContent = "...";
        el.tabAltisIgBestSaves.textContent = "...";
        el.tabAltisGa4ActiveToday.textContent = "...";
        el.tabAltisGa4ActiveYesterday.textContent = "...";
        el.tabAltisGa4Active7d.textContent = "...";
        el.tabAltisGa4SessionsToday.textContent = "...";
        el.tabAltisGa4Sessions7d.textContent = "...";
        el.tabAltisGa4SessionsMonth.textContent = "...";
        setKpiCardSubvalue(el.tabAltisIgBestPlays, "");
        setKpiCardSubvalue(el.tabAltisIgBestReach, "");
        setKpiCardSubvalue(el.tabAltisIgBestSaves, "");
      }

      function setGa4Badge(state, text) {
        el.ga4Badge.className = "ga4-badge";
        if (state === "ok") el.ga4Badge.classList.add("ok");
        if (state === "warn") el.ga4Badge.classList.add("warn");
        if (state === "err") el.ga4Badge.classList.add("err");
        el.ga4Badge.textContent = text;
      }

      function setStatus(state, details = "") {
        if (state === "loading") {
          el.statusDot.style.background = "#7f93b8";
          el.statusText.textContent = "Checking connection...";
          return;
        }
        if (state === "connected") {
          el.statusDot.style.background = "#36c26b";
          el.statusText.textContent = details || "Live Connected";
          return;
        }
        if (state === "auth") {
          el.statusDot.style.background = "#ffb020";
          el.statusText.textContent = details || "Auth Error: Check x-api-key";
          return;
        }
        if (state === "backend") {
          el.statusDot.style.background = "#ff5f56";
          el.statusText.textContent = details || "Backend Down: Check URL/server";
          return;
        }
        if (state === "data") {
          el.statusDot.style.background = "#ff8a3d";
          el.statusText.textContent = details || "Data error: check API credentials";
          return;
        }
        el.statusDot.style.background = "#6d7f9f";
        el.statusText.textContent = details || "Status unknown";
      }

      async function checkLiveStatus() {
        setStatus("loading");
        let healthRes;
        try {
          healthRes = await fetch(resolveUrl("/health"), { method: "GET" });
        } catch {
          setStatus("backend", "Backend Down: cannot reach server");
          return false;
        }
        if (!healthRes.ok) {
          setStatus("backend", `Backend issue: /health HTTP ${healthRes.status}`);
          return false;
        }

        const authCheck = await postJson("/api/tools/run", { tool: "get_meta_spend_today", args: {} });
        if (!authCheck.ok && authCheck.status === 401) {
          setStatus("auth", "Auth Error: invalid x-api-key");
          return false;
        }
        if (!authCheck.ok && authCheck.status === 0) {
          setStatus("backend", "Backend Down: network error");
          return false;
        }
        if (!authCheck.ok) {
          const msg =
            authCheck.json?.primary_error ||
            authCheck.json?.error ||
            authCheck.raw ||
            "Live data failed";
          setStatus("data", `Live data error: ${String(msg).slice(0, 120)}`);
          return false;
        }
        setStatus("connected", "Live Connected");
        return true;
      }

      async function fetchLiveKpis() {
        const hasKey = getApiKey();
        if (!hasKey) {
          setStatus("auth", "Auth Error: x-api-key missing");
          setGa4Badge("err", "GA4: api-key missing");
          return;
        }

        setKpiLoading();
        setGa4Badge("warn", "GA4: checking...");
        const ok = await checkLiveStatus();
        if (!ok) {
          setGa4Badge("err", "GA4: backend/auth issue");
          return;
        }

        const brandAccounts = getBrandAccounts();

        const [
          leads,
          leads30d,
          leads7d,
          spendToday,
          spendMonth,
          spend7d,
          users,
          sessionsToday,
          sessions7d,
          bestCampaign,
          igOverview,
          igBestReel,
          coxwellMetaSpendToday,
          coxwellMetaSpend7d,
          coxwellMetaLeadsToday,
          coxwellMetaLeads7d,
          coxwellMetaBestCampaign,
          coxwellIgOverview,
          coxwellIgBestReel,
          altisMetaSpendToday,
          altisMetaSpend7d,
          altisMetaLeadsToday,
          altisMetaLeads7d,
          altisMetaBestCampaign,
          altisIgOverview,
          altisIgBestReel,
          coxwellGa4ActiveToday,
          coxwellGa4ActiveYesterday,
          coxwellGa4Active7d,
          coxwellGa4SessionsToday,
          coxwellGa4Sessions7d,
          coxwellGa4SessionsMonth,
          altisGa4ActiveToday,
          altisGa4ActiveYesterday,
          altisGa4Active7d,
          altisGa4SessionsToday,
          altisGa4Sessions7d,
          altisGa4SessionsMonth,
          ga4Debug,
        ] = await Promise.all([
          postJson("/api/tools/run", { tool: "get_meta_leads_today", args: {} }),
          postJson("/api/tools/run", { tool: "get_meta_leads_last_30d", args: {} }),
          postJson("/api/tools/run", { tool: "get_meta_leads_last_7d", args: {} }),
          postJson("/api/tools/run", { tool: "get_meta_spend_today", args: {} }),
          postJson("/api/tools/run", { tool: "get_meta_spend_month", args: {} }),
          postJson("/api/tools/run", { tool: "get_meta_spend_last_7d", args: {} }),
          postJson("/api/tools/run", { tool: "get_ga4_active_users_today", args: {} }),
          postJson("/api/tools/run", { tool: "get_ga4_sessions_today", args: {} }),
          postJson("/api/tools/run", { tool: "get_ga4_sessions_last_7_days", args: {} }),
          postJson("/api/tools/run", { tool: "get_meta_best_campaign", args: {} }),
          postJson("/api/tools/run", { tool: "get_instagram_account_overview", args: {} }),
          postJson("/api/tools/run", { tool: "get_instagram_best_reel", args: { period: "maximum" } }),
          postJson("/api/tools/run", { tool: "get_meta_spend_today", args: { account_id: brandAccounts.coxwell } }),
          postJson("/api/tools/run", { tool: "get_meta_spend_last_7d", args: { account_id: brandAccounts.coxwell } }),
          postJson("/api/tools/run", { tool: "get_meta_leads_today", args: { account_id: brandAccounts.coxwell } }),
          postJson("/api/tools/run", { tool: "get_meta_leads_last_7d", args: { account_id: brandAccounts.coxwell } }),
          postJson("/api/tools/run", { tool: "get_meta_best_campaign", args: { account_id: brandAccounts.coxwell } }),
          postJson("/api/tools/run", { tool: "get_instagram_account_overview", args: { account_id: brandAccounts.coxwell } }),
          postJson("/api/tools/run", { tool: "get_instagram_best_reel", args: { account_id: brandAccounts.coxwell, period: "maximum" } }),
          postJson("/api/tools/run", { tool: "get_meta_spend_today", args: { account_id: brandAccounts.altis } }),
          postJson("/api/tools/run", { tool: "get_meta_spend_last_7d", args: { account_id: brandAccounts.altis } }),
          postJson("/api/tools/run", { tool: "get_meta_leads_today", args: { account_id: brandAccounts.altis } }),
          postJson("/api/tools/run", { tool: "get_meta_leads_last_7d", args: { account_id: brandAccounts.altis } }),
          postJson("/api/tools/run", { tool: "get_meta_best_campaign", args: { account_id: brandAccounts.altis } }),
          postJson("/api/tools/run", { tool: "get_instagram_account_overview", args: { account_id: brandAccounts.altis } }),
          postJson("/api/tools/run", { tool: "get_instagram_best_reel", args: { account_id: brandAccounts.altis, period: "maximum" } }),
          postJson("/api/tools/run", { tool: "get_ga4_active_users_today", args: { account_id: brandAccounts.coxwell } }),
          postJson("/api/tools/run", { tool: "get_ga4_active_users_yesterday", args: { account_id: brandAccounts.coxwell } }),
          postJson("/api/tools/run", { tool: "get_ga4_active_users_last_7_days", args: { account_id: brandAccounts.coxwell } }),
          postJson("/api/tools/run", { tool: "get_ga4_sessions_today", args: { account_id: brandAccounts.coxwell } }),
          postJson("/api/tools/run", { tool: "get_ga4_sessions_last_7_days", args: { account_id: brandAccounts.coxwell } }),
          postJson("/api/tools/run", { tool: "get_ga4_sessions_month", args: { account_id: brandAccounts.coxwell } }),
          postJson("/api/tools/run", { tool: "get_ga4_active_users_today", args: { account_id: brandAccounts.altis } }),
          postJson("/api/tools/run", { tool: "get_ga4_active_users_yesterday", args: { account_id: brandAccounts.altis } }),
          postJson("/api/tools/run", { tool: "get_ga4_active_users_last_7_days", args: { account_id: brandAccounts.altis } }),
          postJson("/api/tools/run", { tool: "get_ga4_sessions_today", args: { account_id: brandAccounts.altis } }),
          postJson("/api/tools/run", { tool: "get_ga4_sessions_last_7_days", args: { account_id: brandAccounts.altis } }),
          postJson("/api/tools/run", { tool: "get_ga4_sessions_month", args: { account_id: brandAccounts.altis } }),
          getJson("/api/ga4/debug-tag"),
        ]);

        if (leads.ok) setKpiCardMetric(el.kpiLeads, String(leads.json?.leads ?? "-"));
        else setKpiCardMetric(el.kpiLeads, "-");

        if (leads30d.ok) setKpiCardMetric(el.kpiLeads30d, String(leads30d.json?.leads ?? "-"));
        else setKpiCardMetric(el.kpiLeads30d, "-");
        if (leads7d.ok) setKpiCardMetric(el.kpiLeads7d, String(leads7d.json?.leads ?? "-"));
        else setKpiCardMetric(el.kpiLeads7d, "-");

        if (spendToday.ok) setKpiCardMetric(el.kpiSpendToday, formatCurrencyINR(spendToday.json?.spend));
        else setKpiCardMetric(el.kpiSpendToday, "-");

        if (spendMonth.ok) setKpiCardMetric(el.kpiSpendMonth, formatCurrencyINR(spendMonth.json?.spend));
        else setKpiCardMetric(el.kpiSpendMonth, "-");
        if (spend7d.ok) setKpiCardMetric(el.kpiSpend7d, formatCurrencyINR(spend7d.json?.spend));
        else setKpiCardMetric(el.kpiSpend7d, "-");

        if (users.ok) setKpiCardMetric(el.kpiUsers, String(users.json?.active_users ?? "-"));
        else setKpiCardMetric(el.kpiUsers, "-");

        if (sessionsToday.ok) setKpiCardMetric(el.kpiSessionsToday, String(sessionsToday.json?.sessions ?? "-"));
        else setKpiCardMetric(el.kpiSessionsToday, "-");
        if (sessions7d.ok) setKpiCardMetric(el.kpiGa4Sessions7d, String(sessions7d.json?.sessions ?? "-"));
        else setKpiCardMetric(el.kpiGa4Sessions7d, "-");

        if (bestCampaign.ok) {
          const best = bestCampaign.json?.best || null;
          const top = Array.isArray(bestCampaign.json?.top) ? bestCampaign.json.top : [];
          const worst = top.length ? top[top.length - 1] : null;

          setKpiCardMetric(el.kpiBestCampaign, best?.campaign_name || "-");
          setKpiCardMetric(el.kpiBestCpl, Number.isFinite(Number(best?.cpl)) ? formatCurrencyINR(best.cpl) : "-");
          setKpiCardMetric(el.kpiWorstCampaign, worst?.campaign_name || "-");
        } else {
          setKpiCardMetric(el.kpiBestCampaign, "-");
          setKpiCardMetric(el.kpiBestCpl, "-");
          setKpiCardMetric(el.kpiWorstCampaign, "-");
        }

        if (igOverview.ok) {
          setKpiCardMetric(el.kpiIgFollowers, String(igOverview.json?.account?.followers_count ?? "-"));
        } else {
          setKpiCardMetric(el.kpiIgFollowers, "-");
        }

        if (igBestReel.ok) {
          const bestCaption = String(igBestReel.json?.best?.caption || "").trim();
          const bestPlays = Number(igBestReel.json?.best?.plays ?? NaN);
          const name = bestCaption ? bestCaption.slice(0, 24) : "No reel";
          setKpiCardMetric(el.kpiIgBestReel, Number.isFinite(bestPlays) ? `${name} (${bestPlays})` : name);
        } else {
          setKpiCardMetric(el.kpiIgBestReel, "-");
        }

        el.tabCwMetaSpendToday.textContent = coxwellMetaSpendToday.ok
          ? formatCurrencyINR(coxwellMetaSpendToday.json?.spend)
          : "-";
        el.tabCwMetaSpend7d.textContent = coxwellMetaSpend7d.ok
          ? formatCurrencyINR(coxwellMetaSpend7d.json?.spend)
          : "-";
        el.tabCwMetaLeadsToday.textContent = coxwellMetaLeadsToday.ok
          ? String(coxwellMetaLeadsToday.json?.leads ?? "-")
          : "-";
        el.tabCwMetaLeads7d.textContent = coxwellMetaLeads7d.ok
          ? String(coxwellMetaLeads7d.json?.leads ?? "-")
          : "-";
        el.tabCwMetaBestCampaign.textContent = coxwellMetaBestCampaign.ok
          ? String(coxwellMetaBestCampaign.json?.best?.campaign_name || "No campaign")
          : "-";
        el.tabCwMetaBestCpl.textContent = coxwellMetaBestCampaign.ok
          ? formatCurrencyINR(coxwellMetaBestCampaign.json?.best?.cpl)
          : "-";
        el.tabCwIgFollowers.textContent = coxwellIgOverview.ok
          ? String(coxwellIgOverview.json?.account?.followers_count ?? "-")
          : "-";
        el.tabCwIgFollowing.textContent = coxwellIgOverview.ok
          ? String(coxwellIgOverview.json?.account?.follows_count ?? "-")
          : "-";
        el.tabCwIgMediaCount.textContent = coxwellIgOverview.ok
          ? String(coxwellIgOverview.json?.account?.media_count ?? "-")
          : "-";
        el.tabCwIgBestPlays.textContent = coxwellIgBestReel.ok
          ? String(Number(coxwellIgBestReel.json?.best?.plays ?? 0))
          : "-";
        el.tabCwIgBestReach.textContent = coxwellIgBestReel.ok
          ? String(Number(coxwellIgBestReel.json?.best?.reach ?? 0))
          : "-";
        el.tabCwIgBestSaves.textContent = coxwellIgBestReel.ok
          ? String(Number(coxwellIgBestReel.json?.best?.saved ?? 0))
          : "-";
        el.tabCwGa4ActiveToday.textContent = coxwellGa4ActiveToday.ok
          ? String(coxwellGa4ActiveToday.json?.active_users ?? "-")
          : "-";
        el.tabCwGa4ActiveYesterday.textContent = coxwellGa4ActiveYesterday.ok
          ? String(coxwellGa4ActiveYesterday.json?.active_users ?? "-")
          : "-";
        el.tabCwGa4Active7d.textContent = coxwellGa4Active7d.ok
          ? String(coxwellGa4Active7d.json?.active_users ?? "-")
          : "-";
        el.tabCwGa4SessionsToday.textContent = coxwellGa4SessionsToday.ok
          ? String(coxwellGa4SessionsToday.json?.sessions ?? "-")
          : "-";
        el.tabCwGa4Sessions7d.textContent = coxwellGa4Sessions7d.ok
          ? String(coxwellGa4Sessions7d.json?.sessions ?? "-")
          : "-";
        el.tabCwGa4SessionsMonth.textContent = coxwellGa4SessionsMonth.ok
          ? String(coxwellGa4SessionsMonth.json?.sessions ?? "-")
          : "-";

        el.tabAltisMetaSpendToday.textContent = altisMetaSpendToday.ok
          ? formatCurrencyINR(altisMetaSpendToday.json?.spend)
          : "-";
        el.tabAltisMetaSpend7d.textContent = altisMetaSpend7d.ok
          ? formatCurrencyINR(altisMetaSpend7d.json?.spend)
          : "-";
        el.tabAltisMetaLeadsToday.textContent = altisMetaLeadsToday.ok
          ? String(altisMetaLeadsToday.json?.leads ?? "-")
          : "-";
        el.tabAltisMetaLeads7d.textContent = altisMetaLeads7d.ok
          ? String(altisMetaLeads7d.json?.leads ?? "-")
          : "-";
        el.tabAltisMetaBestCampaign.textContent = altisMetaBestCampaign.ok
          ? String(altisMetaBestCampaign.json?.best?.campaign_name || "No campaign")
          : "-";
        el.tabAltisMetaBestCpl.textContent = altisMetaBestCampaign.ok
          ? formatCurrencyINR(altisMetaBestCampaign.json?.best?.cpl)
          : "-";
        el.tabAltisIgFollowers.textContent = altisIgOverview.ok
          ? String(altisIgOverview.json?.account?.followers_count ?? "-")
          : "-";
        el.tabAltisIgFollowing.textContent = altisIgOverview.ok
          ? String(altisIgOverview.json?.account?.follows_count ?? "-")
          : "-";
        el.tabAltisIgMediaCount.textContent = altisIgOverview.ok
          ? String(altisIgOverview.json?.account?.media_count ?? "-")
          : "-";
        const altisTopReels = Array.isArray(altisIgBestReel.json?.top) ? altisIgBestReel.json.top : [];
        const altisBestByPlays = altisTopReels.reduce((best, r) => {
          const v = Number(r?.plays ?? 0);
          const b = Number(best?.plays ?? -1);
          return v > b ? r : best;
        }, null);
        const altisBestByReach = altisTopReels.reduce((best, r) => {
          const v = Number(r?.reach ?? 0);
          const b = Number(best?.reach ?? -1);
          return v > b ? r : best;
        }, null);
        const altisBestBySaves = altisTopReels.reduce((best, r) => {
          const v = Number(r?.saved ?? 0);
          const b = Number(best?.saved ?? -1);
          return v > b ? r : best;
        }, null);
        el.tabAltisIgBestPlays.textContent = altisIgBestReel.ok
          ? String(Number(altisIgBestReel.json?.best?.plays ?? 0))
          : "-";
        setKpiCardSubvalue(el.tabAltisIgBestPlays, formatReelLabel(altisBestByPlays || altisIgBestReel.json?.best));
        el.tabAltisIgBestReach.textContent = altisIgBestReel.ok
          ? String(Number(altisIgBestReel.json?.best?.reach ?? 0))
          : "-";
        setKpiCardSubvalue(el.tabAltisIgBestReach, formatReelLabel(altisBestByReach || altisIgBestReel.json?.best));
        el.tabAltisIgBestSaves.textContent = altisIgBestReel.ok
          ? String(Number(altisIgBestReel.json?.best?.saved ?? 0))
          : "-";
        setKpiCardSubvalue(el.tabAltisIgBestSaves, formatReelLabel(altisBestBySaves || altisIgBestReel.json?.best));
        el.tabAltisGa4ActiveToday.textContent = altisGa4ActiveToday.ok
          ? String(altisGa4ActiveToday.json?.active_users ?? "-")
          : "-";
        el.tabAltisGa4ActiveYesterday.textContent = altisGa4ActiveYesterday.ok
          ? String(altisGa4ActiveYesterday.json?.active_users ?? "-")
          : "-";
        el.tabAltisGa4Active7d.textContent = altisGa4Active7d.ok
          ? String(altisGa4Active7d.json?.active_users ?? "-")
          : "-";
        el.tabAltisGa4SessionsToday.textContent = altisGa4SessionsToday.ok
          ? String(altisGa4SessionsToday.json?.sessions ?? "-")
          : "-";
        el.tabAltisGa4Sessions7d.textContent = altisGa4Sessions7d.ok
          ? String(altisGa4Sessions7d.json?.sessions ?? "-")
          : "-";
        el.tabAltisGa4SessionsMonth.textContent = altisGa4SessionsMonth.ok
          ? String(altisGa4SessionsMonth.json?.sessions ?? "-")
          : "-";

        const alertMessages = [];
        const coxwellIgDiag = buildInstagramDiagnostic(
          "Coxwell",
          brandAccounts.coxwell,
          coxwellIgOverview,
          coxwellIgBestReel
        );
        const altisIgDiag = buildInstagramDiagnostic(
          "Altis",
          brandAccounts.altis,
          altisIgOverview,
          altisIgBestReel
        );
        if (coxwellIgDiag) alertMessages.push(coxwellIgDiag);
        if (altisIgDiag) alertMessages.push(altisIgDiag);
        if (ga4Debug.ok && Number(ga4Debug.json?.metrics?.today_sessions || 0) === 0) {
          alertMessages.push("GA4 connected but no sessions today.");
        }
        showAlert(alertMessages.join(" "));
        setLastUpdated();
        const hintAccount = activeKpiTab.startsWith("coxwell")
          ? `Coxwell: ${brandAccounts.coxwell || "not set"}`
          : `Altis: ${brandAccounts.altis || "not set"}`;
        if (el.tabAccountHint) el.tabAccountHint.textContent = `Account: ${hintAccount}`;

        if (!ga4Debug.ok) {
          setGa4Badge("err", "GA4: config/access error");
        } else {
          const m = ga4Debug.json?.metrics || {};
          const active = Number(m.realtime_active_users || 0);
          const today = Number(m.today_sessions || 0);
          const last7 = Number(m.last_7_days_sessions || 0);
          if (active > 0 || today > 0 || last7 > 0) {
            setGa4Badge("ok", "GA4: live data detected");
          } else {
            setGa4Badge("warn", "GA4: connected, no traffic yet");
          }
        }
      }

      function upsertMessage(role, text) {
        const c = getCurrentConversation();
        if (!c) return;
        c.messages.push({ id: uid(), role, text, ts: nowIso() });
        c.updatedAt = nowIso();
        c.title = buildTitle(c.messages);
        conversations.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
        persist();
      }

      function renderMessage(msg) {
        const w = document.createElement("div");
        w.className = "msg " + msg.role;
        const avatar = document.createElement("div");
        avatar.className = "avatar";
        avatar.textContent = msg.role === "user" ? "U" : "AI";
        const content = document.createElement("div");
        content.className = "content";
        const meta = document.createElement("div");
        meta.className = "meta";
        meta.innerHTML = `<span>${msg.role}</span><span class="ts">${fmtTime(msg.ts || nowIso())}</span>`;
        const bubble = document.createElement("div");
        bubble.className = "bubble";
        const isEditing = msg.role === "user" && editingMessageId === msg.id;
        if (isEditing) {
          bubble.innerHTML = `
            <div class="edit-box">
              <textarea class="edit-input" id="edit-input-${msg.id}">${escapeHtml(msg.text)}</textarea>
              <div class="actions">
                <button class="icon" id="edit-save-${msg.id}">Save & Resend</button>
                <button class="icon ghost" id="edit-cancel-${msg.id}">Cancel</button>
              </div>
            </div>
          `;
        } else {
          bubble.innerHTML = renderMarkdown(msg.text);
        }
        content.appendChild(meta);
        content.appendChild(bubble);

        if (msg.role === "assistant") {
          const actions = document.createElement("div");
          actions.className = "actions";
          const copyBtn = document.createElement("button");
          copyBtn.className = "icon";
          copyBtn.textContent = "Copy";
          copyBtn.onclick = async () => {
            try {
              await navigator.clipboard.writeText(msg.text);
              copyBtn.textContent = "Copied";
              setTimeout(() => (copyBtn.textContent = "Copy"), 900);
            } catch {}
          };
          actions.appendChild(copyBtn);
          content.appendChild(actions);
        }
        if (msg.role === "user" && !isEditing) {
          const actions = document.createElement("div");
          actions.className = "actions";
          const editBtn = document.createElement("button");
          editBtn.className = "icon ghost";
          editBtn.textContent = "Edit";
          editBtn.onclick = () => startEditMessage(msg.id);
          actions.appendChild(editBtn);
          content.appendChild(actions);
        }

        w.appendChild(avatar);
        w.appendChild(content);

        if (isEditing) {
          setTimeout(() => {
            const input = document.getElementById(`edit-input-${msg.id}`);
            const saveBtn = document.getElementById(`edit-save-${msg.id}`);
            const cancelBtn = document.getElementById(`edit-cancel-${msg.id}`);
            if (input) {
              input.focus();
              input.selectionStart = input.value.length;
              input.selectionEnd = input.value.length;
              input.addEventListener("keydown", (e) => {
                if (e.key === "Escape") {
                  e.preventDefault();
                  cancelEditMessage();
                }
                if ((e.ctrlKey || e.metaKey) && e.key === "Enter") {
                  e.preventDefault();
                  saveEditedMessage(msg.id, input.value);
                }
              });
            }
            if (saveBtn) saveBtn.onclick = () => saveEditedMessage(msg.id, input ? input.value : "");
            if (cancelBtn) cancelBtn.onclick = cancelEditMessage;
          }, 0);
        }

        return w;
      }

      function startEditMessage(messageId) {
        editingMessageId = messageId;
        renderCurrentConversation();
      }

      function cancelEditMessage() {
        editingMessageId = null;
        renderCurrentConversation();
      }

      async function saveEditedMessage(messageId, nextText) {
        const c = getCurrentConversation();
        if (!c) return;
        const text = (nextText || "").trim();
        if (!text) return;

        const idx = c.messages.findIndex((m) => m.id === messageId && m.role === "user");
        if (idx < 0) return;

        c.messages[idx].text = text;
        c.messages[idx].ts = nowIso();
        c.messages = c.messages.slice(0, idx + 1);
        c.updatedAt = nowIso();
        c.title = buildTitle(c.messages);
        editingMessageId = null;
        persist();
        renderConversationList();
        renderCurrentConversation();
        await askAssistant(text, false);
      }

      function renderCurrentConversation() {
        const c = getCurrentConversation();
        el.chat.innerHTML = "";
        if (!c || !c.messages.length) {
          const d = document.createElement("div");
          d.className = "empty";
          d.innerHTML = `
            <div class="title">Welcome to your AI marketing desk</div>
            <div class="subtle">Ask in natural language and get concise answers like ChatGPT.</div>
            <div class="inline-actions">
              <button id="emptyAskTop">Top KPI Summary</button>
              <button id="emptyAskTab" class="ghost">Ask Current Tab Insight</button>
            </div>`;
          el.chat.appendChild(d);
          const topBtn = document.getElementById("emptyAskTop");
          const tabBtn = document.getElementById("emptyAskTab");
          if (topBtn) topBtn.onclick = () => {
            el.msg.value = "Show me overall Meta + GA4 performance snapshot";
            sendCurrent();
          };
          if (tabBtn) tabBtn.onclick = () => {
            const pick = (TAB_QUERIES[activeKpiTab] || [])[0] || "Show me overall performance";
            el.msg.value = pick;
            sendCurrent();
          };
          updateScrollTopVisibility();
          return;
        }
        c.messages.forEach((m) => el.chat.appendChild(renderMessage(m)));
        el.chat.scrollTop = el.chat.scrollHeight;
        updateScrollTopVisibility();
      }

      function addTyping() {
        const w = document.createElement("div");
        w.className = "msg assistant";
        w.innerHTML = `
          <div class="avatar">AI</div>
          <div class="content">
            <div class="meta"><span>assistant</span><span class="ts">typing</span></div>
            <div class="bubble"><span class="typing"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span></div>
          </div>`;
        el.chat.appendChild(w);
        el.chat.scrollTop = el.chat.scrollHeight;
        return w;
      }

      async function askAssistant(question, appendUser = true) {
        const q = question.trim();
        if (!q) return;
        ensureConversation();
        if (appendUser) upsertMessage("user", q);
        renderConversationList();
        renderCurrentConversation();

        el.send.disabled = true;
        el.regen.disabled = true;
        const typing = addTyping();
        const r = await postJson("/api/chat", { message: q });
        typing.remove();

        let answer = "";
        if (!r.ok) {
          if (r.status === 401) answer = "Unauthorized. Please check your x-api-key.";
          else if (r.status === 404) answer = "Endpoint not found. Check backend URL.";
          else answer = r.json?.error || r.raw || "Unknown error.";
        } else {
          answer = r.json?.answer || "Done.";
        }
        upsertMessage("assistant", answer);
        parseKpisFromText(answer);
        renderConversationList();
        renderCurrentConversation();
        el.send.disabled = false;
        el.regen.disabled = false;
        updateScrollTopVisibility();
      }

      function scrollChatToTop() {
        if (el.chat) el.chat.scrollTo({ top: 0, behavior: "smooth" });
      }

      function updateScrollTopVisibility() {
        const chatScrolled = (el.chat?.scrollTop || 0) > 220;
        if (chatScrolled) el.scrollTopBtn.classList.add("show");
        else el.scrollTopBtn.classList.remove("show");
      }

      async function sendCurrent() {
        const q = el.msg.value;
        el.msg.value = "";
        await askAssistant(q, true);
      }

      async function regenerate() {
        const c = getCurrentConversation();
        if (!c) return;
        const prompt = getLastUserPrompt(c);
        if (!prompt) return;
        while (c.messages.length && c.messages[c.messages.length - 1].role === "assistant") c.messages.pop();
        c.updatedAt = nowIso();
        persist();
        renderCurrentConversation();
        await askAssistant(prompt, false);
      }

      function clearConversation() {
        const c = getCurrentConversation();
        if (!c) return;
        c.messages = [];
        c.title = "New chat";
        c.updatedAt = nowIso();
        persist();
        renderConversationList();
        renderCurrentConversation();
      }
      function renameConversation() {
        const c = getCurrentConversation();
        if (!c) return;
        const name = prompt("Rename chat", c.title);
        if (!name || !name.trim()) return;
        c.title = name.trim();
        c.updatedAt = nowIso();
        persist();
        renderConversationList();
      }
      function deleteConversation() {
        if (!conversations.length) return;
        const c = getCurrentConversation();
        if (!c) return;
        conversations = conversations.filter((x) => x.id !== c.id);
        if (!conversations.length) createConversation();
        else currentConversationId = conversations[0].id;
        persist();
        renderConversationList();
        renderCurrentConversation();
      }
      function exportConversation() {
        const c = getCurrentConversation();
        if (!c) return;
        const payload = { exported_at: nowIso(), title: c.title, messages: c.messages };
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `chat-${c.id}.json`;
        a.click();
        URL.revokeObjectURL(a.href);
      }
      function saveConfig() {
        localStorage.setItem("backend-url", el.backendUrl.value.trim());
        localStorage.setItem("x-api-key", el.apiKey.value.trim());
        localStorage.setItem("meta-account-id", (el.metaAccount.value || "").trim());
        upsertMessage("assistant", "Configuration updated successfully.");
        renderCurrentConversation();
        renderConversationList();
        loadMetaAccounts();
        fetchLiveKpis();
        closeSidebarOnMobile();
      }
      async function verifyMetaTokenNow() {
        const resp = await getJson("/api/meta/verify-token");
        if (!resp.ok) {
          const msg = resp.json?.error || resp.raw || "Meta verification failed";
          setStatus("data", `Meta verify failed: ${String(msg).slice(0, 120)}`);
          upsertMessage(
            "assistant",
            `Meta verification failed: ${msg}\n\nPlease refresh META_ACCESS_TOKEN and restart backend.`
          );
          renderCurrentConversation();
          renderConversationList();
          return;
        }
        const j = resp.json || {};
        setStatus("connected", "Meta token verified");
        const lines = [
          "Meta verification successful.",
          `- Account: ${j.account_id || "-"}`,
          `- User: ${j.app_scoped_user?.name || "-"} (${j.app_scoped_user?.id || "-"})`,
          `- Today's sample spend: ${j.sample_spend_today ?? "-"}`,
          `- Currency: ${j.currency || "-"}`,
        ];
        upsertMessage("assistant", lines.join("\n"));
        renderCurrentConversation();
        renderConversationList();
      }
      async function verifyGa4Now() {
        const resp = await getJson("/api/ga4/debug-tag");
        if (!resp.ok) {
          const msg = resp.json?.error || resp.raw || "GA4 debug failed";
          const diag = resp.json?.diagnosis || "GA4 verification failed";
          const actions = Array.isArray(resp.json?.next_actions) ? resp.json.next_actions : [];
          setStatus("data", `GA4 verify failed: ${String(msg).slice(0, 120)}`);
          const lines = [`GA4 debug failed: ${msg}`, "", `Reason: ${diag}`];
          if (actions.length) {
            lines.push("", "Next actions:");
            actions.forEach((a, i) => lines.push(`${i + 1}. ${a}`));
          }
          upsertMessage(
            "assistant",
            lines.join("\n")
          );
          renderCurrentConversation();
          renderConversationList();
          return;
        }
        const j = resp.json || {};
        const metrics = j.metrics || {};
        const actions = Array.isArray(j.next_actions) ? j.next_actions : [];
        const lines = [
          "GA4 debug report:",
          `- Property: ${j.property || "-"}`,
          `- Realtime active users: ${metrics.realtime_active_users ?? "-"}`,
          `- Today sessions: ${metrics.today_sessions ?? "-"}`,
          `- Last 7 days sessions: ${metrics.last_7_days_sessions ?? "-"}`,
          `- Last 30 days sessions: ${metrics.last_30_days_sessions ?? "-"}`,
          `- Diagnosis: ${j.diagnosis || "-"}`,
        ];
        if (actions.length) {
          lines.push("", "Next actions:");
          actions.forEach((a, i) => lines.push(`${i + 1}. ${a}`));
        }
        upsertMessage("assistant", lines.join("\n"));
        renderCurrentConversation();
        renderConversationList();
      }
      function renderChips() {
        el.chips.innerHTML = "";
        const contextual = TAB_QUERIES[activeKpiTab] || [];
        const merged = [...contextual, ...SUGGESTIONS].slice(0, 12);
        merged.forEach((q) => {
          const b = document.createElement("button");
          b.className = "chip";
          b.textContent = q;
          b.onclick = () => {
            el.msg.value = q;
            sendCurrent();
          };
          el.chips.appendChild(b);
        });
      }

      el.send.onclick = sendCurrent;
      el.msg.addEventListener("keydown", (e) => {
        if (e.key === "Enter") sendCurrent();
      });
      el.regen.onclick = regenerate;
      el.clear.onclick = clearConversation;
      el.newChat.onclick = () => createConversation();
      el.newFolder.onclick = createFolder;
      el.renameFolder.onclick = renameActiveFolder;
      el.deleteFolder.onclick = deleteActiveFolder;
      el.rename.onclick = renameConversation;
      el.del.onclick = deleteConversation;
      el.saveCfg.onclick = saveConfig;
      el.verifyMeta.onclick = verifyMetaTokenNow;
      el.verifyGa4.onclick = verifyGa4Now;
      el.metaAccount.onchange = () => {
        localStorage.setItem("meta-account-id", (el.metaAccount.value || "").trim());
        fetchLiveKpis();
      };
      el.export.onclick = exportConversation;
      el.search.oninput = renderConversationList;
      document.addEventListener("click", () => {
        if (openConvMenuId !== null) {
          openConvMenuId = null;
          renderConversationList();
        }
      });
      document.addEventListener("keydown", (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "k") {
          e.preventDefault();
          el.msg.focus();
        }
      });
      el.scrollTopBtn.onclick = scrollChatToTop;
      el.chat.addEventListener("scroll", updateScrollTopVisibility);
      el.tabCoxwellMeta.onclick = () => setActiveKpiTab("coxwell-meta");
      el.tabCoxwellIg.onclick = () => setActiveKpiTab("coxwell-ig");
      el.tabCoxwellGa4.onclick = () => setActiveKpiTab("coxwell-ga4");
      el.tabAltisMeta.onclick = () => setActiveKpiTab("altis-meta");
      el.tabAltisIg.onclick = () => setActiveKpiTab("altis-ig");
      el.tabAltisGa4.onclick = () => setActiveKpiTab("altis-ga4");
      if (el.refreshKpi) el.refreshKpi.onclick = fetchLiveKpis;
      if (el.toggleCompact) el.toggleCompact.onclick = () => {
        compactMode = !compactMode;
        localStorage.setItem("mai-compact", compactMode ? "1" : "0");
        applyCompactMode();
      };
      if (el.navKpi) {
        el.navKpi.onclick = () => {
          setMobileNavActive("kpi");
          scrollToSection(el.kpiSection);
        };
      }
      if (el.navChat) {
        el.navChat.onclick = () => {
          setMobileNavActive("chat");
          scrollToSection(el.chatSection);
          setTimeout(() => el.msg?.focus(), 220);
        };
      }
      if (el.navSettings) {
        el.navSettings.onclick = () => {
          setMobileNavActive("settings");
          if (isMobileViewport()) setSidebarOpen(true);
          else scrollToSection(document.body);
        };
      }
      if (el.toggleSidebar) {
        el.toggleSidebar.onclick = (e) => {
          e.stopPropagation();
          const nextOpen = !document.body.classList.contains("sidebar-open");
          setSidebarOpen(nextOpen);
          if (isMobileViewport()) setMobileNavActive(nextOpen ? "settings" : "kpi");
        };
      }
      if (el.sidebarBackdrop) {
        el.sidebarBackdrop.onclick = () => {
          setSidebarOpen(false);
          setMobileNavActive("kpi");
        };
      }
      if (el.main) {
        el.main.addEventListener("click", () => {
          closeSidebarOnMobile();
          if (isMobileViewport()) setMobileNavActive("chat");
        });
      }
      window.addEventListener("scroll", () => {
        if (!isMobileViewport()) return;
        const chatTop = el.chatSection?.getBoundingClientRect().top ?? 9999;
        const kpiTop = el.kpiSection?.getBoundingClientRect().top ?? 9999;
        if (document.body.classList.contains("sidebar-open")) {
          setMobileNavActive("settings");
          return;
        }
        if (Math.abs(chatTop) < Math.abs(kpiTop)) setMobileNavActive("chat");
        else setMobileNavActive("kpi");
      });
      window.addEventListener("resize", () => {
        if (!isMobileViewport()) setSidebarOpen(false);
      });

      load();
      loadMetaAccounts();
      setActiveKpiTab(activeKpiTab);
      applyCompactMode();
      renderChips();
      renderFolderList();
      renderConversationList();
      renderCurrentConversation();
      setMobileNavActive("kpi");
      fetchLiveKpis();
      updateScrollTopVisibility();
      setInterval(() => {
        if (!document.hidden) fetchLiveKpis();
      }, 300000);
    </script>
  </body>
</html>
